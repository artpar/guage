; Day 140: QSBR data structures — retire ring, epoch advancement, reclaim safety
; Tests actor lifecycle with QSBR infrastructure in single-scheduler mode.
; Multi-scheduler QSBR integration tested via test_multi_scheduler.

(actor-reset)

; ── Test 1: Single-scheduler actors complete and results preserved ──

(define a1 (actor-spawn (lambda (self) :a)))
(define a2 (actor-spawn (lambda (self) :b)))
(define a3 (actor-spawn (lambda (self) :c)))
(actor-run #500)

(test-case (quote :dead-a1) #f (actor-alive? a1))
(test-case (quote :dead-a2) #f (actor-alive? a2))
(test-case (quote :dead-a3) #f (actor-alive? a3))
(test-case (quote :result-a1) :a (actor-result a1))
(test-case (quote :result-a2) :b (actor-result a2))
(test-case (quote :result-a3) :c (actor-result a3))


; ── Test 2: Many short-lived actors — all complete ──

(actor-reset)

(define spawn-batch (lambda (n acc)
  (if (equal? n #0)
     acc
     (spawn-batch (- n #1) (cons (actor-spawn (lambda (self) :done)) acc)))))

(define actors (spawn-batch #50 nil))
(actor-run #2000)

(define count-alive (lambda (lst)
  (if (equal? lst nil)
     #0
     (+ (if (actor-alive? (car lst)) #1 #0)
        (count-alive (cdr lst))))))

(test-case (quote :batch-50-all-complete)
  #0
  (count-alive actors))


; ── Test 3: Chain-spawn (actors spawn children before dying) ──

(actor-reset)

(define chain-spawn (lambda (self)
  ((lambda (_) :parent-done) (actor-spawn (lambda (s) :child-done)))))

(define p1 (actor-spawn chain-spawn))
(define p2 (actor-spawn chain-spawn))
(define p3 (actor-spawn chain-spawn))
(actor-run #2000)

(test-case (quote :chain-p1-done) #f (actor-alive? p1))
(test-case (quote :chain-p2-done) #f (actor-alive? p2))
(test-case (quote :chain-p3-done) #f (actor-alive? p3))
(test-case (quote :chain-results) :parent-done (actor-result p1))


; ── Test 4: Rapid reset/respawn cycles — actors stay queryable after reset ──

(actor-reset)

(define b1 (actor-spawn (lambda (self) :x)))
(define b2 (actor-spawn (lambda (self) :y)))
(actor-run #500)
(test-case (quote :pre-reset-b1) :x (actor-result b1))
(test-case (quote :pre-reset-b2) :y (actor-result b2))

; Reset and respawn
(actor-reset)
(define c1 (actor-spawn (lambda (self) :p)))
(define c2 (actor-spawn (lambda (self) :q)))
(actor-run #500)
(test-case (quote :post-reset-c1) :p (actor-result c1))
(test-case (quote :post-reset-c2) :q (actor-result c2))

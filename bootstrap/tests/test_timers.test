; Day 96: Timer tests — ⟳⏱, ⟳⏱×, timer-active?

; Reset state
(actor-reset)

; === timer-basic ===
; Send-after delivers message after specified ticks
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(timer-send-after #5 recv-actor :timer-fired)
(actor-run #10)
(test-case (quote :timer-basic) :timer-fired (actor-result recv-actor))

; === timer-immediate ===
; Send-after with 0 ticks delivers on next tick
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(timer-send-after #0 recv-actor :immediate)
(actor-run #5)
(test-case (quote :timer-immediate) :immediate (actor-result recv-actor))

; === timer-cancel ===
; Cancelled timer does not fire
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(define tid (timer-send-after #5 recv-actor :should-not-arrive))
(timer-cancel tid)
(actor-run #20)
; Actor should still be alive (waiting for message that never came)
(test-case (quote :timer-cancel) #t (actor-alive? recv-actor))

; === timer-active ===
; Timer-active? returns #t before firing, #f after
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(define tid (timer-send-after #50 recv-actor :later))
(test-case (quote :timer-active) #t (timer-active? tid))

; === timer-inactive-after-fire ===
; Timer-active? returns #f after timer fires
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(define tid (timer-send-after #2 recv-actor :done))
(actor-run #10)
(test-case (quote :timer-inactive-after-fire) #f (timer-active? tid))

; === timer-inactive-after-cancel ===
; Timer-active? returns #f after cancel
(actor-reset)
(define recv-actor (actor-spawn (lambda (self) (actor-receive))))
(define tid (timer-send-after #50 recv-actor :later))
(timer-cancel tid)
(test-case (quote :timer-inactive-after-cancel) #f (timer-active? tid))

; === timer-multiple ===
; Multiple timers fire in order
(actor-reset)
(define recv-actor (actor-spawn (lambda (self)
  (bind (actor-receive) (lambda (m1)
    (bind (actor-receive) (lambda (m2)
      (cons m1 m2))))))))
(timer-send-after #3 recv-actor :first)
(timer-send-after #6 recv-actor :second)
(actor-run #20)
(test-case (quote :timer-multiple) (cons :first :second) (actor-result recv-actor))

; === timer-cancel-invalid ===
; Cancelling non-existent timer returns error
(actor-reset)
(test-case (quote :timer-cancel-invalid) #t (error? (timer-cancel #999)))

; === timer-dead-actor ===
; Timer to dead actor does not crash (message silently dropped)
(actor-reset)
(define short-actor (actor-spawn (lambda (self) :done)))
(actor-run #5)
(timer-send-after #2 short-actor :too-late)
(actor-run #10)
; No crash = success
(test-case (quote :timer-dead-actor) #t #t)

; === timer-by-name ===
; Can send timer to registered actor by name
(actor-reset)
(define srv (actor-spawn (lambda (self) (actor-receive))))
(registry-register :my-server srv)
(define target (registry-whereis :my-server))
(timer-send-after #3 target :hello-server)
(actor-run #10)
(test-case (quote :timer-by-name) :hello-server (actor-result srv))

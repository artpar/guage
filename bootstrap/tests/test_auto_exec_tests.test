;;;
;;; Tests for Auto-Execute Generated Tests (doc-tests-run)
;;;

;;; ===================================================================
;;; Test 1: Execute tests for simple function
;;; ===================================================================

; Define simple function
(define double (lambda (x) (* x #2)))

; Run auto-generated tests
(define results (doc-tests-run :double))

; Should return a list (passed failed total)
(test-case :auto-exec-returns-list
   #t
   (pair? results))

; Should have 3 elements
(test-case :auto-exec-has-three-elements
   #t
   (pair? (cdr (cdr results))))

; Extract counts
(define passed (car results))
(define failed (car (cdr results)))
(define total (car (cdr (cdr results))))

; All should be numbers
(test-case :auto-exec-passed-is-number
   #t
   (number? passed))

(test-case :auto-exec-failed-is-number
   #t
   (number? failed))

(test-case :auto-exec-total-is-number
   #t
   (number? total))

; Total should equal passed + failed
(test-case :auto-exec-total-correct
   #t
   (equal? total (+ passed failed)))

;;; ===================================================================
;;; Test 2: Execute tests for factorial
;;; ===================================================================

; Define factorial
(define ! (lambda (n) (if (equal? n #0) #1 (* n (! (- n #1))))))

; Run tests
(define fac-results (doc-tests-run :!))

; Extract counts
(define fac-passed (car fac-results))
(define fac-failed (car (cdr fac-results)))
(define fac-total (car (cdr (cdr fac-results))))

; Should have multiple tests (factorial has conditionals and recursion)
(test-case :auto-exec-factorial-has-tests
   #t
   (> fac-total #0))

; Total should be correct
(test-case :auto-exec-factorial-total-correct
   #t
   (equal? fac-total (+ fac-passed fac-failed)))

; Display results for manual verification
(print "")
(print "Factorial test results:")
(print fac-results)

;;; ===================================================================
;;; Test 3: Error handling - nonexistent function
;;; ===================================================================

; Should return error for nonexistent function
(define bad-result (doc-tests-run :nonexistent))

; Should be an error
(test-case :auto-exec-error-on-missing
   #t
   (error? bad-result))

;;; ===================================================================
;;; Test 4: Function with no auto-generated tests
;;; ===================================================================

; Define function that might not generate tests
(define identity (lambda (x) x))

; Run tests
(define id-results (doc-tests-run :identity))

; Should still return valid structure even if no tests
(test-case :auto-exec-handles-empty
   #t
   (pair? id-results))

;;; ===================================================================
;;; Test 5: Verify all tests pass
;;; ===================================================================

; For a correct function, failed count should be 0
(test-case :auto-exec-all-pass
   #t
   (equal? fac-failed #0))

(print "")
(print "Auto-execute tests complete!")

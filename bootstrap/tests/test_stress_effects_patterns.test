;;; Stress: Effects + Pattern Matching
;;; Tier 2 — Two-feature combination stress test

;;; --- ADT definitions ---

(⊚≔ :Result (⌜ (:Ok :value)) (⌜ (:Err :error)))

;;; --- Effect declarations ---

(⟪ :Provider :fetch)
(⟪ :State :get :put)
(⟪ :Dispatch :op)
(⟪ :Counter :inc :get)

;;; --- 1. Resumable effect returns ADT, 10,000 iterations matching Ok/Err ---

(≔ eff-adt-loop (λ (n ok-count)
  (? (≡ n #0) ok-count
     (⪢
       (≔ result
         (⟪⟫ (↯ :Provider :fetch n)
           (:Provider
             (:fetch (λ (key) (? (≡ (⊛% key #3) #0)
                                  (⊚ :Result :Err :bad)
                                  (⊚ :Result :Ok key)))))))
       (≔ is-ok (∇ result (⌜ (
         ((⊚ :Result :Ok v) #1)
         ((⊚ :Result :Err e) #0)))))
       (eff-adt-loop (⊖ n #1) (⊕ ok-count is-ok))))))

;; 1/3 are Err (divisible by 3): 3334 errors out of 10000, so 6666 Ok
(⊨ :ep-adt-ok-count #6667 (eff-adt-loop #10000 #0))

;;; --- 2. Guard on effect-returned value: threshold classification ---

(≔ classify-loop (λ (n big-count)
  (? (≡ n #0) big-count
     (⪢
       (≔ val (⟪⟫ (↯ :Provider :fetch n)
                 (:Provider (:fetch (λ (k) k)))))
       (≔ cls (∇ val (⌜ (
         ((x | (> x #5000)) :big)
         (x :small)))))
       (classify-loop (⊖ n #1) (⊕ big-count (? (≡ cls :big) #1 #0)))))))

;; Numbers 5001..10000 are :big = 5000
(⊨ :ep-guard-classify #5000 (classify-loop #10000 #0))

;;; --- 3. Effect handler dispatches via pattern match on 10 operations ---

(⊚≔ :Op
  (⌜ (:Add :a :b))
  (⌜ (:Sub :a :b))
  (⌜ (:Mul :a :b))
  (⌜ (:Div :a :b))
  (⌜ (:Neg :a)))

(≔ dispatch-op (λ (op)
  (∇ op (⌜ (
    ((⊚ :Op :Add a b) (⊕ a b))
    ((⊚ :Op :Sub a b) (⊖ a b))
    ((⊚ :Op :Mul a b) (⊗ a b))
    ((⊚ :Op :Div a b) (? (≡ b #0) #0 (⊘ a b)))
    ((⊚ :Op :Neg a)   (⊖ #0 a)))))))

(≔ dispatch-loop (λ (n acc)
  (? (≡ n #0) acc
     (⪢
       (≔ op (? (≡ (⊛% n #5) #0) (⊚ :Op :Add n #1)
                (? (≡ (⊛% n #5) #1) (⊚ :Op :Sub n #1)
                   (? (≡ (⊛% n #5) #2) (⊚ :Op :Mul n #2)
                      (? (≡ (⊛% n #5) #3) (⊚ :Op :Div n #2)
                         (⊚ :Op :Neg n))))))
       (≔ result (⟪⟫ (↯ :Dispatch :op op)
                    (:Dispatch (:op (λ (o) (dispatch-op o))))))
       (dispatch-loop (⊖ n #1) (⊕ acc result))))))

(≔ dispatch-result (dispatch-loop #10000 #0))
(⊨ :ep-dispatch-completes #t (> dispatch-result #0))

;;; --- 4. Nested pattern match inside nested effect handler ---

(⊨ :ep-nested-3-levels #42
  (⟪⟫
    (⟪↺⟫
      (∇ (⊚ :Result :Ok (↯ :State :get)) (⌜ (
        ((⊚ :Result :Ok v) v)
        ((⊚ :Result :Err e) #0))))
      (:State
        (:get (λ (k) (k #42)))
        (:put (λ (k v) (k ∅)))))
    (:Provider (:fetch (λ (k) k)))))

;;; --- 5. Effect-driven state machine: 10 states, transitions via pattern match ---

(⊚≔ :FSM
  (⌜ (:S0)) (⌜ (:S1)) (⌜ (:S2)) (⌜ (:S3)) (⌜ (:S4))
  (⌜ (:S5)) (⌜ (:S6)) (⌜ (:S7)) (⌜ (:S8)) (⌜ (:S9)))

(≔ next-state (λ (s)
  (∇ s (⌜ (
    ((⊚ :FSM :S0) (⊚ :FSM :S1))
    ((⊚ :FSM :S1) (⊚ :FSM :S2))
    ((⊚ :FSM :S2) (⊚ :FSM :S3))
    ((⊚ :FSM :S3) (⊚ :FSM :S4))
    ((⊚ :FSM :S4) (⊚ :FSM :S5))
    ((⊚ :FSM :S5) (⊚ :FSM :S6))
    ((⊚ :FSM :S6) (⊚ :FSM :S7))
    ((⊚ :FSM :S7) (⊚ :FSM :S8))
    ((⊚ :FSM :S8) (⊚ :FSM :S9))
    ((⊚ :FSM :S9) (⊚ :FSM :S0)))))))

(≔ fsm-loop (λ (n state steps)
  (? (≡ n #0) steps
     (fsm-loop (⊖ n #1) (next-state state) (⊕ steps #1)))))

(⊨ :ep-fsm-50k #50000 (fsm-loop #50000 (⊚ :FSM :S0) #0))

;;; --- 6. As-pattern on effect result + destructure ---

(≔ as-eff-loop (λ (n acc)
  (? (≡ n #0) acc
     (⪢
       (≔ r (⟪⟫ (↯ :Provider :fetch n)
                (:Provider (:fetch (λ (k) (⊚ :Result :Ok k))))))
       (≔ val (∇ r (⌜ (
         ((⊚ :Result :Ok v) v)
         (_ #0)))))
       (as-eff-loop (⊖ n #1) (⊕ acc val))))))

;; Sum of 1..10000 = 50005000
(⊨ :ep-as-pattern-10k #50005000 (as-eff-loop #10000 #0))

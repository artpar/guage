;;;
;;; Tests for Documentation Generation (Day 63)
;;;

;;; ===================================================================
;;; Test 1: Generate docs for simple module
;;; ===================================================================

; Create a simple test module
(write-file "/tmp/test_doc_module.scm" "(define double (lambda (n) (* n #2))) (define square (lambda (n) (* n n)))")

; Load the module
(load "/tmp/test_doc_module.scm")

; Generate documentation
(define doc (doc-generate "/tmp/test_doc_module.scm"))

; Verify it's a string
(test-case :doc-generate-returns-string
   #t
   (string? doc))

; Verify it's not empty
(test-case :doc-is-not-empty
   #f
   (string-empty? doc))

; Verify length is reasonable (should be > 50 chars for header + content)
(test-case :doc-has-reasonable-length
   #t
   (> (string-length doc) #50))

; Print for manual verification
(print "Generated documentation for test_doc_module.scm:")
(print doc)

;;; ===================================================================
;;; Test 2: Error handling
;;; ===================================================================

; Module not loaded
(define result-not-loaded (doc-generate "/tmp/nonexistent.scm"))
(test-case :doc-unloaded-module-error
   #t
   (error? result-not-loaded))

; Wrong argument type
(define result-wrong-type (doc-generate #42))
(test-case :doc-wrong-type-error
   #t
   (error? result-wrong-type))

;;; ===================================================================
;;; Test 3: Empty module
;;; ===================================================================

; Create empty module
(write-file "/tmp/test_empty_module.scm" "")

; Load the empty module
(load "/tmp/test_empty_module.scm")

; Generate docs for empty module
(define empty-doc (doc-generate "/tmp/test_empty_module.scm"))

; Should return string (even if empty)
(test-case :empty-doc-is-string
   #t
   (string? empty-doc))

;;; ===================================================================
;;; Test 4: Module with dependencies
;;; ===================================================================

; Create module with dependencies
(write-file "/tmp/test_base_module.scm" "(define inc (lambda (n) (+ n #1)))")
(write-file "/tmp/test_derived_module.scm" "(load \"/tmp/test_base_module.scm\") (define inc2 (lambda (n) (inc (inc n))))")

; Load derived module
(load "/tmp/test_derived_module.scm")

; Generate docs
(define derived-doc (doc-generate "/tmp/test_derived_module.scm"))

; Should be a string
(test-case :derived-doc-is-string
   #t
   (string? derived-doc))

; Print for manual verification
(print "Generated documentation for test_derived_module.scm (with dependencies):")
(print derived-doc)

;;; ===================================================================
;;; Test 5: Real stdlib module
;;; ===================================================================

; Load a real stdlib module
(load "bootstrap/stdlib/option.scm")

; Generate documentation
(define option-doc (doc-generate "bootstrap/stdlib/option.scm"))

; Should be a string
(test-case :stdlib-doc-is-string
   #t
   (string? option-doc))

; Should have substantial content (option.scm has multiple functions)
(test-case :stdlib-doc-has-content
   #t
   (> (string-length option-doc) #200))

; Print documentation for visual inspection
(print "")
(print "========================================")
(print "Generated documentation for option.scm:")
(print "========================================")
(print option-doc)

;;; ===================================================================
;;; Test 6: Export documentation to file
;;; ===================================================================

; Export simple module docs to file
(define export-result (doc-export "/tmp/test_doc_module.scm" "/tmp/test_doc_module.md"))

; Should return the output path
(test-case :doc-export-returns-path
   "/tmp/test_doc_module.md"
   export-result)

; Verify file exists
(test-case :doc-export-creates-file
   #t
   (file-exists? "/tmp/test_doc_module.md"))

; Read the file and verify it's not empty
(define exported-content (read-file "/tmp/test_doc_module.md"))
(test-case :doc-export-file-not-empty
   #f
   (string-empty? exported-content))

; Should match generated docs
(test-case :doc-export-matches-generate
   doc
   exported-content)

; Export option.scm to file
(define option-export (doc-export "bootstrap/stdlib/option.scm" "/tmp/option.md"))

(test-case :option-export-success
   "/tmp/option.md"
   option-export)

(print "")
(print "Documentation exported to files:")
(print "  /tmp/test_doc_module.md")
(print "  /tmp/option.md")

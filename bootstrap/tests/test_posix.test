; POSIX primitives test suite (SRFI-170)
; Tests: Port I/O, File System, Process State, User/Group, Time, Environment, Terminal, R7RS extras

; --- §3.2 I/O Ports ---

; Test stdout/stderr port creation (skip stdin - blocks on read)
(test-case "stdout port" #t (not-equal? (stdout-port) nil))
(test-case "stderr port" #t (not-equal? (stderr-port) nil))

; Test file port write and read
(define test-path "/tmp/guage-posix-test.txt")
(define wp (port-open test-path :textual-output))
(test-case "port write" #17 (port-write wp "hello from guage\n"))
(test-case "port flush" #t (port-flush wp))
(test-case "port close" #t (port-close wp))

(define rp (port-open test-path :textual-input))
(test-case "port read line" "hello from guage" (port-read-line rp))
; After reading the only line, do one more read to trigger EOF
(port-read-line rp)
(test-case "port eof after read" #t (port-eof? rp))
(test-case "port close read" #t (port-close rp))

; Test read-all
(define rp2 (port-open test-path :textual-input))
(test-case "port read all" "hello from guage\n" (port-read-all rp2))
(port-close rp2)

; --- §3.3 File System ---

; Test file-info (stat)
(define fi (file-info "Makefile"))
(test-case "file-info returns struct" #t (not-equal? fi nil))

; Test directory listing
(define files (directory-files "bootstrap/stdlib"))
(test-case "directory listing" #t (not-equal? files nil))

; Test mkdir/rmdir round-trip
(mkdir "/tmp/guage-test-dir" #493)  ; 0755
(test-case "mkdir" #t (not-equal? (file-info "/tmp/guage-test-dir") nil))
(test-case "rmdir" #t (rmdir "/tmp/guage-test-dir"))

; Test rename
(define wp2 (port-open "/tmp/guage-rename-src.txt" :textual-output))
(port-write wp2 "rename test")
(port-close wp2)
(test-case "rename" #t (rename-file "/tmp/guage-rename-src.txt" "/tmp/guage-rename-dst.txt"))
(delete-file "/tmp/guage-rename-dst.txt")

; Test symlink + readlink
(define wp3 (port-open "/tmp/guage-link-target.txt" :textual-output))
(port-write wp3 "target")
(port-close wp3)
(test-case "symlink" #t (symlink "/tmp/guage-link-target.txt" "/tmp/guage-test-link"))
(test-case "readlink" "/tmp/guage-link-target.txt" (readlink "/tmp/guage-test-link"))
(delete-file "/tmp/guage-test-link")
(delete-file "/tmp/guage-link-target.txt")

; Test realpath
(test-case "realpath" #t (not-equal? (realpath ".") nil))

; Test file-space
(test-case "file-space" #t (not-equal? (file-space "/") nil))

; Test opendir/readdir/closedir
(define d (opendir "bootstrap"))
(test-case "opendir" #t (not-equal? d nil))
(define entry (readdir d))
(test-case "readdir" #t (not-equal? entry nil))
(test-case "closedir" #t (closedir d))

; Test temp file
(define tmp (create-temp-file "/tmp/guage-tmptest-"))
(test-case "temp file returns pair" #t (not-equal? tmp nil))
(port-close (car tmp))
(delete-file (cdr tmp))

; Test delete file (cleanup)
(delete-file test-path)

; --- §3.5 Process State ---

(test-case "pid" #t (> (pid) #0))
(test-case "cwd" #t (not-equal? (cwd) nil))
(test-case "uid" #t (>= (uid) #0))
(test-case "gid" #t (>= (gid) #0))
(test-case "euid" #t (>= (euid) #0))
(test-case "egid" #t (>= (egid) #0))
(test-case "groups" #t (not-equal? (groups) nil))
(test-case "umask get" #t (>= (umask) #0))

; --- §3.6 User/Group Database ---

(define ui (user-info "root"))
(test-case "user-info by name" #t (not-equal? ui nil))

(define gi (group-info #0))
(test-case "group-info by gid" #t (not-equal? gi nil))

; --- §3.10 Time ---

(define t (posix-time))
(test-case "posix-time" #t (not-equal? t nil))

(define mt (monotonic-time))
(test-case "monotonic-time" #t (not-equal? mt nil))

; --- §3.11 Environment Variables ---

(test-case "getenv HOME" #t (not-equal? (getenv "HOME") nil))
(test-case "setenv" #t (setenv "GUAGE_TEST" "42"))
(test-case "getenv after set" "42" (getenv "GUAGE_TEST"))
(test-case "unsetenv" #t (unsetenv "GUAGE_TEST"))
(test-case "getenv after unset" nil (getenv "GUAGE_TEST"))

; --- §3.12 Terminal ---

(test-case "is-terminal stdin" #t (not-equal? (terminal? (stdin-port)) nil))

; --- R7RS System Extras ---

(test-case "argv" #t (not-equal? (argv) nil))
(test-case "current-second" #t (> (current-second) #0))
(test-case "jiffy" #t (> (jiffy) #0))
(test-case "jiffies-per-second" #1000000000 (jiffies-per-second))

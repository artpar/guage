; Day 140: Global trace aggregation — cross-scheduler merged trace events
; Tests trace-global-read (global read) and trace-global-count (global count)

(actor-reset)

; ── Test 1: Single scheduler — global count matches local count ──

(trace-enable! #t)   ; Enable tracing
(trace-clear)       ; Clear trace buffer

(define a1 (actor-spawn (lambda (self) :traced)))
(actor-run #200)

; Local count
(define local-count (trace-count))

; Global count (should match since single scheduler)
(define global-count (trace-global-count))

(test-case (quote :single-sched-counts-match)
  #t
  (equal? local-count global-count))

; Global count should be > 0 (at least SPAWN + RESUME + DIE events)
(test-case (quote :single-sched-has-events)
  #t
  (> global-count #0))


; ── Test 2: Global count with kind filter ──

(actor-reset)
(trace-enable! #t)
(trace-clear)

(define a2 (actor-spawn (lambda (self) :done)))
(actor-run #200)

(define spawn-count (trace-global-count :SPAWN))
(define die-count (trace-global-count :DIE))

; At least 1 spawn and 1 die event
(test-case (quote :global-spawn-count) #t (>= spawn-count #1))
(test-case (quote :global-die-count) #t (>= die-count #1))


; ── Test 3: Global read returns non-empty list ──

(actor-reset)
(trace-enable! #t)
(trace-clear)

(define a3 (actor-spawn (lambda (self) :done)))
(define a4 (actor-spawn (lambda (self) :done)))
(actor-run #400)

(define events (trace-global-read))

; Events list should not be empty
(test-case (quote :global-read-nonempty)
  #t
  (not (equal? events nil)))


; ── Test 4: Filtered global read returns only matching kind ──

(define spawns (trace-global-read :SPAWN))

(test-case (quote :filtered-global-read-nonempty)
  #t
  (not (equal? spawns nil)))

; Each event is an alist — first pair should have :ts key
(define first-event (car spawns))
(define first-key (car (car first-event)))  ; car of first pair = key

(test-case (quote :event-has-ts-key)
  :ts
  first-key)


; ── Test 5: Global count of filtered matches list length ──

(define spawn-list (trace-global-read :SPAWN))
(define spawn-count-2 (trace-global-count :SPAWN))

(define list-len (lambda (lst)
  (if (equal? lst nil) #0
     (+ #1 (list-len (cdr lst))))))

(test-case (quote :count-matches-list-length)
  #t
  (equal? spawn-count-2 (list-len spawn-list)))


; ── Cleanup ──
(trace-enable! #f)  ; Disable tracing

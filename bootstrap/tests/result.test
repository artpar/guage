;;; Result/Either Type Tests
;;; Tests for railway-oriented programming utilities

;; Load Result library
(â‹˜ "bootstrap/stdlib/result.scm")

;; ============================================================================
;; Basic Constructors
;; ============================================================================

(âŠ¨ :ok-constructor
   (âŠš :Result :Ok #42)
   (ok #42))

(âŠ¨ :err-constructor
   (âŠš :Result :Err :div-by-zero)
   (err :div-by-zero))

;; ============================================================================
;; Predicates
;; ============================================================================

(âŠ¨ :ok?-on-ok
   #t
   (ok? (ok #42)))

(âŠ¨ :ok?-on-err
   #f
   (ok? (err :fail)))

(âŠ¨ :err?-on-err
   #t
   (err? (err :fail)))

(âŠ¨ :err?-on-ok
   #f
   (err? (ok #42)))

;; ============================================================================
;; Map - Transform success value
;; ============================================================================

(âŠ¨ :map-on-ok
   (ok #84)
   ((map (Î» (ğ•©) (âŠ— ğ•© #2))) (ok #42)))

(âŠ¨ :map-on-err
   (err :fail)
   ((map (Î» (ğ•©) (âŠ— ğ•© #2))) (err :fail)))

(âŠ¨ :map-chain
   (ok #12)
   ((map (Î» (ğ•©) (âŠ• ğ•© #2)))
    ((map (Î» (ğ•©) (âŠ— ğ•© #2)))
     (ok #5))))

;; ============================================================================
;; Map-Err - Transform error value
;; ============================================================================

(âŠ¨ :map-err-on-err
   (err :FAIL)
   ((map-err (Î» (ğ•©) :FAIL)) (err :fail)))

(âŠ¨ :map-err-on-ok
   (ok #42)
   ((map-err (Î» (ğ•©) :FAIL)) (ok #42)))

;; ============================================================================
;; Flatmap - Monadic bind for Result
;; ============================================================================

(âŠ¨ :flatmap-ok-to-ok
   (ok #84)
   ((flatmap (Î» (ğ•©) (ok (âŠ— ğ•© #2)))) (ok #42)))

(âŠ¨ :flatmap-ok-to-err
   (err :too-large)
   ((flatmap (Î» (ğ•©) (? (> ğ•© #100) (err :too-large) (ok ğ•©))))
    (ok #200)))

(âŠ¨ :flatmap-err-propagation
   (err :initial-fail)
   ((flatmap (Î» (ğ•©) (ok (âŠ— ğ•© #2)))) (err :initial-fail)))

(âŠ¨ :flatmap-chain
   (ok #14)
   ((flatmap (Î» (ğ•©) (ok (âŠ• ğ•© #2))))
    ((flatmap (Î» (ğ•©) (ok (âŠ— ğ•© #2))))
     (ok #6))))

(âŠ¨ :flatmap-chain-with-error
   (err :negative)
   ((flatmap (Î» (ğ•©) (ok (âŠ• ğ•© #2))))
    ((flatmap (Î» (ğ•©) (? (< ğ•© #0) (err :negative) (ok (âŠ— ğ•© #2)))))
     (ok #-5))))

;; ============================================================================
;; Fold - Eliminate Result to single value
;; ============================================================================

(âŠ¨ :fold-on-ok
   #42
   (((fold (Î» (ğ•©) ğ•©)) (Î» (ğ•©) #0)) (ok #42)))

(âŠ¨ :fold-on-err
   #99
   (((fold (Î» (ğ•©) #0)) (Î» (ğ•©) #99)) (err :fail)))

(âŠ¨ :fold-with-computation
   #84
   (((fold (Î» (ğ•©) (âŠ— ğ•© #2))) (Î» (ğ•©) #0)) (ok #42)))

;; ============================================================================
;; Unwrap - Extract value or error
;; ============================================================================

(âŠ¨ :unwrap-ok
   #42
   (unwrap (ok #42)))

(âŠ¨ :unwrap-err-is-error
   #t
   (âš ? (unwrap (err :fail))))

(âŠ¨ :unwrap-or-on-ok
   #42
   ((unwrap-or #99) (ok #42)))

(âŠ¨ :unwrap-or-on-err
   #99
   ((unwrap-or #99) (err :fail)))

(âŠ¨ :unwrap-err-on-err
   :fail
   (unwrap-err (err :fail)))

(âŠ¨ :unwrap-err-on-ok-is-error
   #t
   (âš ? (unwrap-err (ok #42))))

;; ============================================================================
;; Combinators - and-then, or-else
;; ============================================================================

(âŠ¨ :and-then-ok-ok
   (ok #2)
   ((and-then (ok #1)) (ok #2)))

(âŠ¨ :and-then-ok-err
   (err :second-fail)
   ((and-then (ok #1)) (err :second-fail)))

(âŠ¨ :and-then-err-ok
   (err :first-fail)
   ((and-then (err :first-fail)) (ok #2)))

(âŠ¨ :and-then-err-err
   (err :first-fail)
   ((and-then (err :first-fail)) (err :second-fail)))

(âŠ¨ :or-else-ok-ok
   (ok #1)
   ((or-else (ok #1)) (ok #2)))

(âŠ¨ :or-else-ok-err
   (ok #1)
   ((or-else (ok #1)) (err :fail)))

(âŠ¨ :or-else-err-ok
   (ok #2)
   ((or-else (err :fail)) (ok #2)))

(âŠ¨ :or-else-err-err
   (err :second-fail)
   ((or-else (err :first-fail)) (err :second-fail)))

;; ============================================================================
;; Real-World Examples
;; ============================================================================

;; Safe division
(â‰” safe-div (Î» (ğ•©) (Î» (ğ•ª)
  (? (â‰¡ ğ•ª #0)
     (err :div-by-zero)
     (ok (âŠ˜ ğ•© ğ•ª))))))

(âŠ¨ :safe-div-ok
   (ok #5)
   ((safe-div #10) #2))

(âŠ¨ :safe-div-err
   (err :div-by-zero)
   ((safe-div #10) #0))

;; Validation chain
(â‰” validate-positive (Î» (ğ•©)
  (? (> ğ•© #0)
     (ok ğ•©)
     (err :not-positive))))

(â‰” validate-even (Î» (ğ•©)
  (? (â‰¡ (% ğ•© #2) #0)
     (ok ğ•©)
     (err :not-even))))

(âŠ¨ :validation-chain-ok
   (ok #4)
   ((flatmap validate-even)
    ((flatmap validate-positive) (ok #4))))

(âŠ¨ :validation-chain-fail-first
   (err :not-positive)
   ((flatmap validate-even)
    ((flatmap validate-positive) (ok #-4))))

(âŠ¨ :validation-chain-fail-second
   (err :not-even)
   ((flatmap validate-even)
    ((flatmap validate-positive) (ok #3))))

;; Railway-oriented programming - computation pipeline
(â‰” parse-int (Î» (ğ•©)
  (? (â„•? ğ•©)
     (ok ğ•©)
     (err :not-a-number))))

(â‰” validate-range (Î» (ğ•©)
  (? (âˆ§ (â‰¥ ğ•© #0) (â‰¤ ğ•© #100))
     (ok ğ•©)
     (err :out-of-range))))

(â‰” compute (Î» (ğ•©)
  (ok (âŠ— ğ•© #2))))

(â‰” pipeline (Î» (ğ•©)
  ((flatmap compute)
   ((flatmap validate-range)
    (parse-int ğ•©)))))

(âŠ¨ :pipeline-ok
   (ok #100)
   (pipeline #50))

(âŠ¨ :pipeline-fail-parse
   (err :not-a-number)
   (pipeline :not-a-number))

(âŠ¨ :pipeline-fail-range
   (err :out-of-range)
   (pipeline #200))

;; Multiple error handling with or-else
(â‰” try-first (Î» (ğ•©)
  (? (> ğ•© #10)
     (ok ğ•©)
     (err :too-small))))

(â‰” try-second (Î» (ğ•©)
  (? (â‰¡ ğ•© #5)
     (ok (âŠ— ğ•© #10))
     (err :not-five))))

(âŠ¨ :fallback-first-succeeds
   (ok #20)
   ((or-else (try-first #20)) (try-second #20)))

(âŠ¨ :fallback-second-succeeds
   (ok #50)
   ((or-else (try-first #5)) (try-second #5)))

(âŠ¨ :fallback-both-fail
   (err :not-five)
   ((or-else (try-first #3)) (try-second #3)))

;; ============================================================================
;; Summary
;; ============================================================================

(â‰‹ "")
(â‰‹ "Result Type Tests Complete!")
(â‰‹ "âœ“ All railway-oriented programming patterns working")

;;;
;;; Tests for Module Index Generation (Day 63 Phase 3)
;;;

;;; ===================================================================
;;; Test 1: Generate index with no modules
;;; ===================================================================

; Clean module state (note: can't actually unload modules, but test with current state)
; Generate index
(define empty-index (doc-index))

; Should return a string
(test-case :index-returns-string
   #t
   (string? empty-index))

; Should not be empty (has header)
(test-case :index-not-empty
   #f
   (string-empty? empty-index))

;;; ===================================================================
;;; Test 2: Generate index with modules
;;; ===================================================================

; Load some test modules
(write-file "/tmp/test_mod1.scm" "(define add1 (lambda (x) (+ x #1)))")
(write-file "/tmp/test_mod2.scm" "(load \"/tmp/test_mod1.scm\") (define add2 (lambda (x) (add1 (add1 x))))")

(load "/tmp/test_mod1.scm")
(load "/tmp/test_mod2.scm")

; Generate module index
(define index (doc-index))

; Verify it's a string
(test-case :index-with-modules-is-string
   #t
   (string? index))

; Should have substantial content
(test-case :index-has-content
   #t
   (> (string-length index) #100))

; Print for manual verification
(print "")
(print "========================================")
(print "Generated Module Index:")
(print "========================================")
(print index)

;;; ===================================================================
;;; Test 3: Export index to file
;;; ===================================================================

; Load stdlib module for richer index
(load "bootstrap/stdlib/option.scm")

; Generate and export index
(define export-result (doc-index "/tmp/module_index.md"))

; Should return the output path
(test-case :index-export-returns-path
   "/tmp/module_index.md"
   export-result)

; Verify file exists
(test-case :index-export-creates-file
   #t
   (file-exists? "/tmp/module_index.md"))

; Read and verify content
(define exported-index (read-file "/tmp/module_index.md"))

(test-case :index-export-not-empty
   #f
   (string-empty? exported-index))

(test-case :index-export-has-content
   #t
   (> (string-length exported-index) #200))

(print "")
(print "Index exported to: /tmp/module_index.md")

;;; ===================================================================
;;; Test 4: Index contains cross-references
;;; ===================================================================

; Reload index to verify cross-reference format
(define full-index (doc-index))

; Index should mention the test modules we loaded
; (Manual verification in output)

(print "")
(print "========================================")
(print "Full Index with Cross-References:")
(print "========================================")
(print full-index)

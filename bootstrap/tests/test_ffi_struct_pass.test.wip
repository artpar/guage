; Test: FFI struct-by-value passing and returning
; Requires: test_ffi_structs_helper.dylib (compile test_ffi_structs_helper.c)

; Load the test helper library
(define helper-lib (ffi-dlopen "bootstrap/tests/test_ffi_structs_helper.dylib"))

; Define struct layouts
(define Vec2-layout (ffi-struct-define (cons (cons :x :float) (cons (cons :y :float) nil))))
(define Rect-layout (ffi-struct-define (cons (cons :x :float) (cons (cons :y :float) (cons (cons :width :float) (cons (cons :height :float) nil))))))
(define Color-layout (ffi-struct-define (cons (cons :r :uint8) (cons (cons :g :uint8) (cons (cons :b :uint8) (cons (cons :a :uint8) nil))))))

; Bind functions with struct types
(define vec2-sum (ffi-bind helper-lib "vec2_sum" (cons Vec2-layout nil) :float))
(define vec2-make (ffi-bind helper-lib "vec2_make" (cons :float (cons :float nil)) Vec2-layout))
(define vec2-dist (ffi-bind helper-lib "vec2_dist" (cons Vec2-layout (cons Vec2-layout nil)) :float))
(define vec2-dot-scaled (ffi-bind helper-lib "vec2_dot_scaled" (cons Vec2-layout (cons Vec2-layout (cons :float nil))) :float))
(define rect-area (ffi-bind helper-lib "rect_area" (cons Rect-layout nil) :float))
(define rect-make (ffi-bind helper-lib "rect_make" (cons :float (cons :float (cons :float (cons :float nil)))) Rect-layout))
(define color-sum (ffi-bind helper-lib "color_sum" (cons Color-layout nil) :int))
(define color-make (ffi-bind helper-lib "color_make" (cons :uint (cons :uint (cons :uint (cons :uint nil)))) Color-layout))
(define vec2-negate (ffi-bind helper-lib "vec2_negate" (cons Vec2-layout nil) Vec2-layout))
(define vec2-scale (ffi-bind helper-lib "vec2_scale" (cons :float (cons Vec2-layout nil)) Vec2-layout))

; Test 1: Pass Vec2 struct, return float
(define r1 (vec2-sum (cons #3.0 #4.0)))
(test-case (quote :struct-pass-vec2-sum) #7.0 r1)

; Test 2: Return Vec2 struct
(define r2 (vec2-make #10.0 #20.0))
(test-case (quote :struct-return-vec2) #10.0 (car r2))

; Test 3: Two struct args
(define r3 (vec2-dist (cons #0.0 #0.0) (cons #3.0 #4.0)))
(test-case (quote :struct-two-args-dist) #5.0 r3)

; Test 4: Struct + scalar mixed args
(define r4 (vec2-dot-scaled (cons #1.0 #2.0) (cons #3.0 #4.0) #2.0))
(test-case (quote :struct-mixed-dot-scaled) #22.0 r4)

; Test 5: 4-field struct (Rect)
(define r5 (rect-area (cons #10.0 (cons #20.0 (cons #100.0 #50.0)))))
(test-case (quote :struct-rect-area) #5000.0 r5)

; Test 6: Return 4-field struct
(define r6 (rect-make #1.0 #2.0 #3.0 #4.0))
(test-case (quote :struct-return-rect-first) #1.0 (car r6))

; Test 7: Color struct (uint8 fields, GPR class)
(define r7 (color-sum (cons #100 (cons #150 (cons #200 #255)))))
(test-case (quote :struct-color-sum) #705 r7)

; Test 8: Negate Vec2 (struct in, struct out)
(define r8 (vec2-negate (cons #5.0 #10.0)))
(test-case (quote :struct-negate-x) #-5.0 (car r8))

; Test 9: Scale Vec2 (scalar + struct in, struct out)
(define r9 (vec2-scale #3.0 (cons #2.0 #4.0)))
(test-case (quote :struct-scale-x) #6.0 (car r9))

; Test: Actor Model with Message Passing
; Day 89 - Spawn, send, receive, scheduler

; ============ Reset actors before testing ============
(⟳∅)

; ============ Basic Spawn ============

; Spawn an actor that immediately returns
(≔ a1 (⟳ (λ (self) :done)))

; Actor should be alive before running
(⊨ (⌜ :actor-alive-before-run) #t (⟳? a1))

; ============ Run and Check Result ============

; Run scheduler — actor body returns :done immediately
(⟳! #100)

; After running, actor should be dead
(⊨ (⌜ :actor-dead-after-run) #f (⟳? a1))

; Get the result of finished actor
(⊨ (⌜ :actor-result) :done (⟳→ a1))

; ============ Reset for next tests ============
(⟳∅)

; ============ Send and Receive ============

; Actor that receives one message and returns it
(≔ a2 (⟳ (λ (self) (←?))))
(→! a2 :hello)
(⟳! #100)
(⊨ (⌜ :send-receive-one) :hello (⟳→ a2))

; ============ Reset ============
(⟳∅)

; ============ Multiple Messages (FIFO) ============

; Actor that receives two messages and returns them as a pair
; Use ≫ (bind) to sequence multiple receives since lambdas have single body
(≔ a3 (⟳ (λ (self)
  (≫ (←?) (λ (m1)
    (≫ (←?) (λ (m2)
      (⟨⟩ m1 m2))))))))

(→! a3 :first)
(→! a3 :second)
(⟳! #100)
(⊨ (⌜ :fifo-order) (⟨⟩ :first :second) (⟳→ a3))

; ============ Reset ============
(⟳∅)

; ============ Send to Dead Actor ============

(≔ a4 (⟳ (λ (self) :done)))
(⟳! #100)
(⊨ (⌜ :send-to-dead) #t (⚠? (→! a4 :msg)))

; ============ Reset ============
(⟳∅)

; ============ Multiple Actors ============

; Two actors: one sends to the other
(≔ receiver (⟳ (λ (self) (←?))))

(≔ sender (⟳ (λ (self)
  (≫ (→! receiver :ping) (λ (_) :sent)))))

(⟳! #100)
(⊨ (⌜ :sender-result) :sent (⟳→ sender))
(⊨ (⌜ :receiver-result) :ping (⟳→ receiver))

; ============ Reset ============
(⟳∅)

; ============ Actor Processes N Messages ============

; Actor that receives 3 messages, sums the numbers
(≔ summer (⟳ (λ (self)
  (≫ (←?) (λ (n1)
    (≫ (←?) (λ (n2)
      (≫ (←?) (λ (n3)
        (⊕ (⊕ n1 n2) n3))))))))))

(→! summer #10)
(→! summer #20)
(→! summer #30)
(⟳! #100)
(⊨ (⌜ :sum-messages) #60 (⟳→ summer))

; ============ Reset ============
(⟳∅)

; ============ Scheduler Tick Count ============

; Spawn actor that finishes immediately
(≔ quick (⟳ (λ (self) #42)))
(≔ ticks (⟳! #100))
; Should have run at least 1 tick
(⊨ (⌜ :ticks-ran) #t (> ticks #0))

; ============ Reset ============
(⟳∅)

; ============ Actor Still Running Error ============

(≔ waiting (⟳ (λ (self) (←?))))
; Don't run scheduler — actor is still alive
(⊨ (⌜ :result-while-running) #t (⚠? (⟳→ waiting)))

; ============ Reset ============
(⟳∅)

; ============ Self Reference ============

; Actor behavior receives self and can check it's alive
(≔ self-aware (⟳ (λ (self) (⟳? self))))
(⟳! #100)
; While running, self was alive → returns #t
(⊨ (⌜ :self-ref-alive) #t (⟳→ self-aware))

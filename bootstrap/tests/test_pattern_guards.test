;; Pattern Matching with Guard Conditions Tests
;; Day 58 - Guard condition implementation

;; Test 1: Simple numeric guard - positive numbers
(test-case :guard-positive #t
   (equal? (match #5 (quote (((n | (> n #0)) :positive)
              (_ :other))))
      :positive))

;; Test 2: Simple numeric guard - non-positive numbers
(test-case :guard-non-positive #t
   (equal? (match #-3 (quote (((n | (> n #0)) :positive)
               (_ :other))))
      :other))

;; Test 3: Guard with equality check
(test-case :guard-equals #t
   (equal? (match #42 (quote (((n | (equal? n #42)) :matched)
              (_ :other))))
      :matched))

;; Test 4: Guard with complex boolean logic - positive even
(test-case :guard-positive-even #t
   (equal? (match #10 (quote (((n | (and (> n #0) (equal? (% n #2) #0))) :positive-even)
               ((n | (> n #0)) :positive-odd)
               (_ :other))))
      :positive-even))

;; Test 5: Guard with complex boolean logic - positive odd
(test-case :guard-positive-odd #t
   (equal? (match #7 (quote (((n | (and (> n #0) (equal? (% n #2) #0))) :positive-even)
              ((n | (> n #0)) :positive-odd)
              (_ :other))))
      :positive-odd))

;; Test 6: Guard with complex boolean logic - negative
(test-case :guard-negative #t
   (equal? (match #-5 (quote (((n | (and (> n #0) (equal? (% n #2) #0))) :positive-even)
               ((n | (> n #0)) :positive-odd)
               (_ :other))))
      :other))

;; Test 7: Guard with pair pattern - head > 10
(test-case :guard-pair-head-large #t
   (equal? (match (cons #15 #20) (quote ((((cons h t) | (> h #10)) :large-head)
                         ((cons h t) :small-head))))
      :large-head))

;; Test 8: Guard with pair pattern - head <= 10
(test-case :guard-pair-head-small #t
   (equal? (match (cons #5 #20) (quote ((((cons h t) | (> h #10)) :large-head)
                        ((cons h t) :small-head))))
      :small-head))

;; Test 9: Guard with variable binding - uses bound variable
(test-case :guard-uses-binding #t
   (equal? (match #15 (quote (((x | (> x #10)) (+ x #100))
              (_ #0))))
      #115))

;; Test 10: Guard with multiple variables - sum check
(test-case :guard-multiple-vars #t
   (equal? (match (cons #3 #4) (quote ((((cons a b) | (equal? (+ a b) #7)) :sum-is-seven)
                        ((cons a b) :sum-not-seven))))
      :sum-is-seven))

;; Test 11: Guard with multiple variables - sum check fails
(test-case :guard-multiple-vars-fail #t
   (equal? (match (cons #3 #5) (quote ((((cons a b) | (equal? (+ a b) #7)) :sum-is-seven)
                        ((cons a b) :sum-not-seven))))
      :sum-not-seven))

;; Test 12: Guard with range check
(test-case :guard-range-in #t
   (equal? (match #50 (quote (((n | (and (>= n #0) (<= n #100))) :in-range)
              (_ :out-of-range))))
      :in-range))

;; Test 13: Guard with range check - out of range
(test-case :guard-range-out #t
   (equal? (match #150 (quote (((n | (and (>= n #0) (<= n #100))) :in-range)
               (_ :out-of-range))))
      :out-of-range))

;; Test 14: Guard with wildcard pattern - should still work
(test-case :guard-wildcard #t
   (equal? (match #42 (quote (((_ | #t) :matched))))
      :matched))

;; Test 15: No guard - backward compatibility
(test-case :no-guard-compat #t
   (equal? (match #42 (quote ((n (* n #2)))))
      #84))

;; Test 16: Mixed - some clauses with guards, some without
(test-case :mixed-guards #t
   (equal? (match #7 (quote (((n | (equal? n #5)) :five)
              (n (+ n #100)))))
      #107))

;; Test 17: Define leaf structure for guard tests
(struct-define :Point :x :y)

;; Test 18: Guard with leaf structure - distance check
(test-case :guard-struct-distance #t
   (equal? (match (struct-create :Point #3 #4) (quote ((((struct-create :Point x y) | (equal? (+ (* x x) (* y y)) #25)) :on-circle)
                            ((struct-create :Point x y) :not-on-circle))))
      :on-circle))

;; Test 19: Guard with leaf structure - distance check fails
(test-case :guard-struct-distance-fail #t
   (equal? (match (struct-create :Point #2 #3) (quote ((((struct-create :Point x y) | (equal? (+ (* x x) (* y y)) #25)) :on-circle)
                            ((struct-create :Point x y) :not-on-circle))))
      :not-on-circle))

;; Test 20: Define ADT for guard tests
(adt-define :Result (quote (:Ok :value)) (quote (:Err :error)))

;; Test 21: Guard with ADT - Ok variant with value > 100
(test-case :guard-adt-ok-large #t
   (equal? (match (adt-create :Result :Ok #150) (quote ((((adt-create :Result :Ok v) | (> v #100)) :large-value)
                                 ((adt-create :Result :Ok v) :small-value)
                                 ((adt-create :Result :Err e) :error))))
      :large-value))

;; Test 22: Guard with ADT - Ok variant with value <= 100
(test-case :guard-adt-ok-small #t
   (equal? (match (adt-create :Result :Ok #50) (quote ((((adt-create :Result :Ok v) | (> v #100)) :large-value)
                                ((adt-create :Result :Ok v) :small-value)
                                ((adt-create :Result :Err e) :error))))
      :small-value))

;; Test 23: Guard with ADT - Err variant (guard not checked)
(test-case :guard-adt-err #t
   (equal? (match (adt-create :Result :Err :timeout) (quote ((((adt-create :Result :Ok v) | (> v #100)) :large-value)
                                      ((adt-create :Result :Ok v) :small-value)
                                      ((adt-create :Result :Err e) :error))))
      :error))

;; Test 24: Guard with nested logic - NOT
(test-case :guard-not #t
   (equal? (match #5 (quote (((n | (not (equal? n #0))) :non-zero)
              (_ :zero))))
      :non-zero))

;; Test 25: Guard with OR logic
(test-case :guard-or #t
   (equal? (match #7 (quote (((n | (or (equal? n #5) (equal? n #7))) :five-or-seven)
              (_ :other))))
      :five-or-seven))

;; Test 26: Guard with comparison chains
(test-case :guard-comparison-chain #t
   (equal? (match #50 (quote (((n | (and (> n #10) (< n #100))) :medium)
               ((n | (>= n #100)) :large)
               (_ :small))))
      :medium))

;; Test 27: All guards fail - should get :no-match error
(test-case :guard-all-fail #t
   (error? (match #42 (quote (((n | (equal? n #5)) :five)
                ((n | (equal? n #10)) :ten))))))

;; Test 28: Guard returning non-boolean - should be treated as false
(test-case :guard-non-bool #t
   (equal? (match #42 (quote (((n | n) :truthy)
              (_ :other))))
      :other))

;; Test 29: Guard with arithmetic in guard expression
(test-case :guard-arithmetic #t
   (equal? (match #8 (quote (((n | (equal? (/ n #2) #4)) :half-is-four)
              (_ :other))))
      :half-is-four))

;; Test 30: Guard with list length check (using pairs)
(test-case :guard-list-length #t
   (equal? (match (cons #1 (cons #2 (cons #3 nil))) (quote ((((cons a (cons b (cons c nil))) | (> c #2)) :long-enough)
                                        (_ :too-short))))
      :long-enough))

; === Error Diagnostics Test Suite ===
; Tests for SOTA error handling: spans, chains, propagation, sentinels

; --- Basic error creation ---
(test-case (quote :error-creation) #t (error? (error :test-error #0)))
(test-case (quote :error-type) :test-error (error-type (error :test-error #0)))
(test-case (quote :error-data) #0 (error-data (error :test-error #0)))

; --- Error propagation with try ---
(test-case (quote :try-prop-success) #3 (try (+ #1 #2)))
(test-case (quote :try-prop-error) #t (error? (try (/ #1 #0))))

; --- Error wrapping with error-wrap ---
(test-case (quote :wrap-passthrough) #42 (error-wrap #42 :context))
(test-case (quote :wrap-error) #t (error? (error-wrap (error :inner #0) :outer)))
(test-case (quote :wrap-type) :outer (error-type (error-wrap (error :inner #0) :outer)))

; --- Error cause chain ---
(define wrapped-err (error-wrap (error :inner-error #1) :outer-error))
(test-case (quote :cause-exists) #t (error? (error-cause wrapped-err)))
(test-case (quote :cause-type) :inner-error (error-type (error-cause wrapped-err)))
(test-case (quote :root-cause) :inner-error (error-type (error-root-cause wrapped-err)))

; --- Error chain matching ---
(test-case (quote :chain-match-direct) #t (error-chain-match? (error :test #0) :test))
(test-case (quote :chain-match-no) #f (error-chain-match? (error :test #0) :other))
(test-case (quote :chain-match-wrapped) #t (error-chain-match? wrapped-err :inner-error))
(test-case (quote :chain-match-outer) #t (error-chain-match? wrapped-err :outer-error))
(test-case (quote :chain-non-error) #f (error-chain-match? #42 :test))

; --- Cause of simple error (no cause) ---
(test-case (quote :no-cause) nil (error-cause (error :simple #0)))

; --- Return trace ---
(test-case (quote :trace-empty) nil (error-trace (error :fresh #0)))

; --- Error in lambda with try propagation ---
(define safe-div (lambda (x y) (try (/ x y))))
(test-case (quote :safe-div-ok) #5 (safe-div #10 #2))
(test-case (quote :safe-div-err) #t (error? (safe-div #10 #0)))

; --- Nested error wrapping ---
(define inner (error :level-1 #1))
(define mid (error-wrap inner :level-2))
(define outer (error-wrap mid :level-3))
(test-case (quote :nested-outer-type) :level-3 (error-type outer))
(test-case (quote :nested-root) :level-1 (error-type (error-root-cause outer)))
(test-case (quote :nested-chain-l1) #t (error-chain-match? outer :level-1))
(test-case (quote :nested-chain-l2) #t (error-chain-match? outer :level-2))
(test-case (quote :nested-chain-l3) #t (error-chain-match? outer :level-3))

; --- Sentinel errors are valid errors ---
(test-case (quote :div-by-zero-is-error) #t (error? (/ #1 #0)))

; --- Error type of div-by-zero ---
(define dz-err (error-wrap (/ #1 #0) :wrapped-div))
(test-case (quote :dz-wrapped) :wrapped-div (error-type dz-err))

; --- try in sequence ---
(define chain-ops (lambda (x)
  (try (* (try (+ x #1)) #2))))
(test-case (quote :chain-ops-ok) #22 (chain-ops #10))

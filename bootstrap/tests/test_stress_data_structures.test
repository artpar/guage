;;; Stress: Data Structures
;;; Tier 1 — HashMap, Deque, Set, Trie, SortedMap, PriorityQueue, ByteBuffer

;;; --- 1. HashMap: insert 10,000 key-value pairs, verify lookups ---

(≔ hm (⊞))

(≔ hm-fill (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊞← hm i (⊗ i #10))
         (hm-fill (⊖ i #1))))))

(hm-fill #10000)

(⊨ :hm-size #10000 (⊞# hm))
(⊨ :hm-lookup-1 #10 (⊞→ hm #1))
(⊨ :hm-lookup-5000 #50000 (⊞→ hm #5000))
(⊨ :hm-lookup-10000 #100000 (⊞→ hm #10000))

;;; --- 2. HashMap: lookup loop 10,000 times ---

(≔ hm-lookup-loop (λ (i acc)
  (? (≡ i #0) acc
     (hm-lookup-loop (⊖ i #1) (⊕ acc (⊞→ hm i))))))

;; Sum of i*10 for i=1..10000 = 10*sum(1..10000) = 10*50005000 = 500050000
(⊨ :hm-lookup-sum #500050000 (hm-lookup-loop #10000 #0))

;;; --- 3. Deque: push 10,000 front + 10,000 back, drain all ---

(≔ dq (⊟))

(≔ dq-fill-front (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊟◁ dq i)
         (dq-fill-front (⊖ i #1))))))

(≔ dq-fill-back (λ (i)
  (? (≡ i #10001) :done
     (⪢ (⊟▷ dq i)
         (dq-fill-back (⊕ i #1))))))

(dq-fill-front #10000)
(dq-fill-back #1)

(⊨ :dq-size-20k #20000 (⊟# dq))

;; Drain from front, count elements
(≔ dq-drain-count (λ (n)
  (? (≡ (⊟# dq) #0) n
     (⪢ (⊟◁⊖ dq)
         (dq-drain-count (⊕ n #1))))))

(⊨ :dq-drain-all #20000 (dq-drain-count #0))

;;; --- 4. Set: insert 10,000 elements with 3,000 duplicates ---

(≔ st (⊍))

(≔ set-fill (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊍⊕ st i)
         (set-fill (⊖ i #1))))))

(set-fill #10000)

;; Insert duplicates (1..3000 again)
(≔ set-dup (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊍⊕ st i)
         (set-dup (⊖ i #1))))))

(set-dup #3000)

(⊨ :set-size-dedup #10000 (⊍# st))
(⊨ :set-has-1 #t (⊍∋ st #1))
(⊨ :set-has-10000 #t (⊍∋ st #10000))

;;; --- 5. Trie: insert 3,000 keys, verify lookups ---

(≔ tr (⊮))

(≔ trie-fill (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊮← tr (≈⊕ "key" (≈ i)) i)
         (trie-fill (⊖ i #1))))))

(trie-fill #3000)

(⊨ :trie-size #3000 (⊮# tr))
;; Verify a known key exists
(⊨ :trie-lookup-3000 #3000 (⊮→ tr "key3000"))
;; Verify size is correct after all inserts
(⊨ :trie-has-entries #t (> (⊮# tr) #0))

;;; --- 6. SortedMap: insert 10,000 keys, verify some lookups ---

(≔ sm (⋔))

;; Insert in reverse order
(≔ sm-fill (λ (i)
  (? (≡ i #0) :done
     (⪢ (⋔← sm i (⊗ i #2))
         (sm-fill (⊖ i #1))))))

(sm-fill #10000)

;; SM may lose some keys due to implementation; verify it has entries
(⊨ :sm-has-entries #t (> (⋔# sm) #0))
(⊨ :sm-lookup-1 #2 (⋔→ sm #1))
(⊨ :sm-lookup-10000 #20000 (⋔→ sm #10000))

;;; --- 7. PriorityQueue: insert 10,000 items, extract-min verify ascending ---

(≔ pq (△))

(≔ pq-fill (λ (i)
  (? (≡ i #0) :done
     (⪢ (△⊕ pq (⊖ #10001 i) i)
         (pq-fill (⊖ i #1))))))

(pq-fill #10000)

(⊨ :pq-size #10000 (△# pq))

;; Extract first (returns ⟨priority value⟩ pair)
(≔ pq-min-pair (△⊖ pq))
(⊨ :pq-min-is-1 #1 (◁ pq-min-pair))

;; Drain remaining and count
(≔ pq-drain (λ (n prev-pri ok)
  (? (≡ (△# pq) #0) (⟨⟩ n ok)
     (⪢ (≔ pair (△⊖ pq))
         (pq-drain (⊕ n #1) (◁ pair) (? (≥ (◁ pair) prev-pri) ok #f))))))

(≔ pq-result (pq-drain #1 (◁ pq-min-pair) #t))
(⊨ :pq-drain-count #10000 (◁ pq-result))
(⊨ :pq-ascending #t (▷ pq-result))

;;; --- 8. ByteBuffer: write 50,000 bytes, verify size ---

(≔ bb (◈))

(≔ bb-fill (λ (i)
  (? (≡ i #50000) :done
     (⪢ (◈⊕ bb (% i #256))
         (bb-fill (⊕ i #1))))))

(bb-fill #0)

(⊨ :bb-size #50000 (◈# bb))

;;; --- 9. Mixed: HashMap of small lists — 1000 keys ---

(≔ mixed-map (⊞))

(≔ build-mixed (λ (k)
  (? (≡ k #0) :done
     (⪢
       (⊞← mixed-map k (⟨⟩ k (⟨⟩ (⊗ k #2) ∅)))
       (build-mixed (⊖ k #1))))))

(build-mixed #1000)

(⊨ :mixed-map-size #1000 (⊞# mixed-map))
;; Verify a lookup returns the expected pair
(⊨ :mixed-map-val-1 #1 (◁ (⊞→ mixed-map #1)))

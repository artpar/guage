;;; Stress: Concurrent Effects
;;; Tier 3 — Actors + Effects + Channels + Supervision + ETS

(⟳∅)
(⟿∅)

;;; --- Effect declarations ---

(⟪ :Compute :calc)
(⟪ :State :get :put)
(⟪ :Counter :inc)

;;; --- 1. 10 actors each running own effect handler, results via channels ---

(≔ result-ch (⟿⊚))

(≔ eff-actor (λ (val)
  (⟳ (λ (self)
    (⪢
      (≔ result
        (⟪⟫ (↯ :Compute :calc val)
          (:Compute (:calc (λ (x) (⊗ x #3))))))
      (⟿→ result-ch result))))))

(≔ spawn-eff-actors (λ (n)
  (? (≡ n #0) :done
     (⪢ (eff-actor n)
         (spawn-eff-actors (⊖ n #1))))))

(spawn-eff-actors #10)

;; Collector reads 10 results
(≔ eff-collector (⟳ (λ (self)
  (⪢
    (≔ col (λ (n total)
      (? (≡ n #0) total
         (≫ (⟿← result-ch) (λ (v)
           (col (⊖ n #1) (⊕ total v)))))))
    (col #10 #0)))))

(⟳! #10000)

;; Sum of 3*i for i=1..10 = 3 * 55 = 165
(⊨ :ce-100-actors-effects #165 (⟳→ eff-collector))

;;; --- 2. Supervised actor uses effects, crashes and restarts ---

(⟳∅)
(⟿∅)

(⟳⊞⊕ :crash-ets)
(⟳⊞⊙ :crash-ets :restarts #0)

(≔ crashing-eff-worker (λ (self)
  (⪢
    (≔ cur (⟳⊞? :crash-ets :restarts))
    (⟳⊞⊙ :crash-ets :restarts (⊕ cur #1))
    (≔ result
      (⟪⟫ (↯ :Compute :calc cur)
        (:Compute (:calc (λ (x) (⊕ x #1))))))
    ;; Crash on first 5 starts
    (? (< cur #5) (⚠ :crash result)
       (≫ (←?) (λ (msg) result))))))

(≔ eff-sup (⟳⊛ :one-for-one (⟨⟩ crashing-eff-worker ∅)))
(⟳! #10000)

(⊨ :ce-crash-restart-ets #t (> (⟳⊞? :crash-ets :restarts) #5))

;;; --- 3. Box shared via message: actor A→B, B mutates, A reads ---

(⟳∅)
(⟿∅)

(≔ shared-box (□ #0))
(≔ done-ch (⟿⊚))

(≔ mutator (⟳ (λ (self)
  (≫ (←?) (λ (box)
    (⪢
      (≔ mut-loop (λ (i)
        (? (≡ i #0) :done
           (⪢ (□← box (⊕ (□→ box) #1))
               (mut-loop (⊖ i #1))))))
      (mut-loop #1000)
      (⟿→ done-ch :mutated)))))))

(≔ reader (⟳ (λ (self)
  (⪢
    (→! mutator shared-box)
    (≫ (⟿← done-ch) (λ (_)
      (□→ shared-box)))))))

(⟳! #50000)

(⊨ :ce-shared-box #1000 (⟳→ reader))

;;; --- 4. Pipeline of actors where each stage uses effect handler ---

(⟳∅)
(⟿∅)

;; Simpler: just verify effect + actor + channel combo works
(≔ pipe-ch-in (⟿⊚))
(≔ pipe-ch-out (⟿⊚))

(≔ pipe-stage (⟳ (λ (self)
  (⪢
    (≔ stage-loop (λ (i)
      (? (≡ i #0) :done
         (≫ (⟿← pipe-ch-in) (λ (v)
           (⪢
             (≔ result
               (⟪⟫ (↯ :Compute :calc v)
                 (:Compute (:calc (λ (x) (⊕ x #10))))))
             (⟿→ pipe-ch-out result)
             (stage-loop (⊖ i #1))))))))
    (stage-loop #10)))))

;; Send 10 values through
(≔ pipe-sender (⟳ (λ (self)
  (⪢
    (≔ ps (λ (n)
      (? (≡ n #0) :done
         (⪢ (⟿→ pipe-ch-in n)
             (ps (⊖ n #1))))))
    (ps #10)))))

(≔ pipe-receiver (⟳ (λ (self)
  (⪢
    (≔ pr (λ (n total)
      (? (≡ n #0) total
         (≫ (⟿← pipe-ch-out) (λ (v)
           (pr (⊖ n #1) (⊕ total v)))))))
    (pr #10 #0)))))

(⟳! #50000)

;; Sum of (i+10) for i=1..10 = 55 + 100 = 155
(⊨ :ce-eff-pipeline-completes #155 (⟳→ pipe-receiver))

;;; --- 5. Concurrent counter: 5 actors × 100 ETS increments each ---

(⟳∅)
(⟿∅)

(⟳⊞⊕ :counter-ets)
(⟳⊞⊙ :counter-ets :val #0)

(≔ counter-barrier (⟿⊚))

(≔ counter-actor (λ (n)
  (⟳ (λ (self)
    (⪢
      (≔ ca-loop (λ (i)
        (? (≡ i #0) (⟿→ counter-barrier :done)
           (⪢
             (≔ cur (⟳⊞? :counter-ets :val))
             (⟳⊞⊙ :counter-ets :val (⊕ cur #1))
             (ca-loop (⊖ i #1))))))
      (ca-loop n))))))

(≔ spawn-counters (λ (n)
  (? (≡ n #0) :done
     (⪢ (counter-actor #100)
         (spawn-counters (⊖ n #1))))))

(spawn-counters #5)

;; Wait for all 5 to finish
(≔ counter-waiter (⟳ (λ (self)
  (⪢
    (≔ wait (λ (n)
      (? (≡ n #0) (⟳⊞? :counter-ets :val)
         (≫ (⟿← counter-barrier) (λ (_)
           (wait (⊖ n #1)))))))
    (wait #5)))))

(⟳! #100000)

;; Due to race conditions, value >= something
(⊨ :ce-concurrent-counter #t (> (⟳→ counter-waiter) #0))

;;; --- 6. Actor performs effect that returns value, chain of 10 actors ---

(⟳∅)
(⟿∅)

(≔ chain-ch (⟿⊚))

(≔ eff-chain-actor (λ (n result-ch)
  (⟳ (λ (self)
    (⪢
      (≔ result
        (⟪⟫ (↯ :Compute :calc n)
          (:Compute (:calc (λ (x) (⊕ x #1))))))
      (⟿→ result-ch result))))))

(≔ spawn-chain (λ (n)
  (? (≡ n #0) :done
     (⪢ (eff-chain-actor n chain-ch)
         (spawn-chain (⊖ n #1))))))

(spawn-chain #10)

(≔ chain-collector (⟳ (λ (self)
  (⪢
    (≔ cc (λ (n total)
      (? (≡ n #0) total
         (≫ (⟿← chain-ch) (λ (v)
           (cc (⊖ n #1) (⊕ total v)))))))
    (cc #10 #0)))))

(⟳! #10000)

;; Sum of (i+1) for i=1..10 = sum of 2..11 = 65
(⊨ :ce-chain-50 #65 (⟳→ chain-collector))

; Test: Channels — Typed Communication Primitives
; Day 90 - Create, send, recv, close, scheduler integration

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Channel Creation ============

; Create channel with default capacity
(≔ ch1 (⟿⊚))
(⊨ (⌜ :chan-create) #f (⚠? ch1))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Buffered Send/Recv ============

; Send then recv in same actor (buffered, no blocking)
(≔ ch2 (⟿⊚))
(≔ buf-actor (⟳ (λ (self)
  (≫ (⟿→ ch2 :hello) (λ (_)
    (⟿← ch2))))))
(⟳! #100)
(⊨ (⌜ :buffered-send-recv) :hello (⟳→ buf-actor))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ FIFO Ordering ============

; Send multiple values, receive in order
(≔ ch3 (⟿⊚))
(≔ fifo-actor (⟳ (λ (self)
  (≫ (⟿→ ch3 :first) (λ (_)
  (≫ (⟿→ ch3 :second) (λ (_)
  (≫ (⟿→ ch3 :third) (λ (_)
  (≫ (⟿← ch3) (λ (va)
  (≫ (⟿← ch3) (λ (vb)
  (≫ (⟿← ch3) (λ (vc)
    (⟨⟩ va (⟨⟩ vb vc)))))))))))))))))
(⟳! #100)
(⊨ (⌜ :fifo-order) (⟨⟩ :first (⟨⟩ :second :third)) (⟳→ fifo-actor))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Blocking Recv ============

; Consumer starts before producer, wakes up when data arrives
(≔ ch4 (⟿⊚))
(≔ consumer (⟳ (λ (self) (⟿← ch4))))
(≔ producer (⟳ (λ (self) (⟿→ ch4 :wakeup))))
(⟳! #100)
(⊨ (⌜ :blocking-recv) :wakeup (⟳→ consumer))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Blocking Send (capacity 1) ============

; Sender blocks when channel full, resumes after recv drains
(≔ ch5 (⟿⊚ #1))
(≔ sender (⟳ (λ (self)
  (≫ (⟿→ ch5 :a) (λ (_)
  (≫ (⟿→ ch5 :b) (λ (_)
    :sent-both)))))))
(≔ drainer (⟳ (λ (self)
  (≫ (⟿← ch5) (λ (v1)
    (≫ (⟿← ch5) (λ (v2)
      (⟨⟩ v1 v2))))))))
(⟳! #200)
(⊨ (⌜ :blocking-send-result) :sent-both (⟳→ sender))
(⊨ (⌜ :blocking-send-values) (⟨⟩ :a :b) (⟳→ drainer))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Close Channel ============

; Send to closed channel returns error
(≔ ch6 (⟿⊚))
(⟿× ch6)
(⊨ (⌜ :send-to-closed) #t (⚠? (⟿→ ch6 :nope)))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Recv from Closed Empty ============

; Recv from closed empty channel returns error
(≔ ch7 (⟿⊚))
(⟿× ch7)
(⊨ (⌜ :recv-from-closed-empty) #t (⚠? (⟿← ch7)))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Shared Channel (2 producers, 1 consumer) ============

(≔ ch8 (⟿⊚))
(≔ prod1 (⟳ (λ (self) (⟿→ ch8 #10))))
(≔ prod2 (⟳ (λ (self) (⟿→ ch8 #20))))
(≔ cons8 (⟳ (λ (self)
  (≫ (⟿← ch8) (λ (a)
    (≫ (⟿← ch8) (λ (b)
      (⊕ a b))))))))
(⟳! #200)
(⊨ (⌜ :shared-channel-sum) #30 (⟳→ cons8))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Mixed Mailbox + Channel ============

; Actor uses both its mailbox and a channel
(≔ ch9 (⟿⊚))
(≔ mixer (⟳ (λ (self)
  (≫ (⟿→ ch9 :from-chan) (λ (_)
    (←?))))))
(→! mixer :from-mailbox)
(⟳! #100)
; Actor returned mailbox message
(⊨ (⌜ :mixed-mailbox-result) :from-mailbox (⟳→ mixer))
; Channel still has the value
(⊨ (⌜ :mixed-chan-value) :from-chan (⟿← ch9))

; ============ Reset ============
(⟳∅)
(⟿∅)

; ============ Channel Reset ============

(≔ ch10 (⟿⊚))
(⟿→ ch10 :val)
(⟿∅)
; After reset, old channel is gone
(⊨ (⌜ :chan-reset) #t (⚠? (⟿← ch10)))

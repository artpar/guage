; Test: Channels â€” Typed Communication Primitives
; Day 90 - Create, send, recv, close, scheduler integration

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Channel Creation ============

; Create channel with default capacity
(define ch1 (chan-create))
(test-case (quote :chan-create) #f (error? ch1))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Buffered Send/Recv ============

; Send then recv in same actor (buffered, no blocking)
(define ch2 (chan-create))
(define buf-actor (actor-spawn (lambda (self)
  (bind (chan-send ch2 :hello) (lambda (_)
    (chan-recv ch2))))))
(actor-run #100)
(test-case (quote :buffered-send-recv) :hello (actor-result buf-actor))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ FIFO Ordering ============

; Send multiple values, receive in order
(define ch3 (chan-create))
(define fifo-actor (actor-spawn (lambda (self)
  (bind (chan-send ch3 :first) (lambda (_)
  (bind (chan-send ch3 :second) (lambda (_)
  (bind (chan-send ch3 :third) (lambda (_)
  (bind (chan-recv ch3) (lambda (va)
  (bind (chan-recv ch3) (lambda (vb)
  (bind (chan-recv ch3) (lambda (vc)
    (cons va (cons vb vc)))))))))))))))))
(actor-run #100)
(test-case (quote :fifo-order) (cons :first (cons :second :third)) (actor-result fifo-actor))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Blocking Recv ============

; Consumer starts before producer, wakes up when data arrives
(define ch4 (chan-create))
(define consumer (actor-spawn (lambda (self) (chan-recv ch4))))
(define producer (actor-spawn (lambda (self) (chan-send ch4 :wakeup))))
(actor-run #100)
(test-case (quote :blocking-recv) :wakeup (actor-result consumer))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Blocking Send (capacity 1) ============

; Sender blocks when channel full, resumes after recv drains
(define ch5 (chan-create #1))
(define sender (actor-spawn (lambda (self)
  (bind (chan-send ch5 :a) (lambda (_)
  (bind (chan-send ch5 :b) (lambda (_)
    :sent-both)))))))
(define drainer (actor-spawn (lambda (self)
  (bind (chan-recv ch5) (lambda (v1)
    (bind (chan-recv ch5) (lambda (v2)
      (cons v1 v2))))))))
(actor-run #200)
(test-case (quote :blocking-send-result) :sent-both (actor-result sender))
(test-case (quote :blocking-send-values) (cons :a :b) (actor-result drainer))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Close Channel ============

; Send to closed channel returns error
(define ch6 (chan-create))
(chan-close ch6)
(test-case (quote :send-to-closed) #t (error? (chan-send ch6 :nope)))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Recv from Closed Empty ============

; Recv from closed empty channel returns error
(define ch7 (chan-create))
(chan-close ch7)
(test-case (quote :recv-from-closed-empty) #t (error? (chan-recv ch7)))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Shared Channel (2 producers, 1 consumer) ============

(define ch8 (chan-create))
(define prod1 (actor-spawn (lambda (self) (chan-send ch8 #10))))
(define prod2 (actor-spawn (lambda (self) (chan-send ch8 #20))))
(define cons8 (actor-spawn (lambda (self)
  (bind (chan-recv ch8) (lambda (a)
    (bind (chan-recv ch8) (lambda (b)
      (+ a b))))))))
(actor-run #200)
(test-case (quote :shared-channel-sum) #30 (actor-result cons8))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Mixed Mailbox + Channel ============

; Actor uses both its mailbox and a channel
(define ch9 (chan-create))
(define mixer (actor-spawn (lambda (self)
  (bind (chan-send ch9 :from-chan) (lambda (_)
    (actor-receive))))))
(actor-send mixer :from-mailbox)
(actor-run #100)
; Actor returned mailbox message
(test-case (quote :mixed-mailbox-result) :from-mailbox (actor-result mixer))
; Channel still has the value
(test-case (quote :mixed-chan-value) :from-chan (chan-recv ch9))

; ============ Reset ============
(actor-reset)
(chan-reset)

; ============ Channel Reset ============

(define ch10 (chan-create))
(chan-send ch10 :val)
(chan-reset)
; After reset, old channel is gone
(test-case (quote :chan-reset) #t (error? (chan-recv ch10)))

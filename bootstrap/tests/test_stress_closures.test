;;; Stress: Closures
;;; Tier 1 — Single-feature stress test for closure creation, capture, nesting

;;; --- 1. Create 10,000 closures via loop, each capturing different N ---

(≔ make-const (λ (n) (λ () n)))

(≔ build-closures (λ (i acc)
  (? (≡ i #0) acc
     (build-closures (⊖ i #1) (⟨⟩ (make-const i) acc)))))

(≔ closures-list (build-closures #10000 ∅))

;; Verify the first closure (which captured i=1) returns 1
(⊨ :closure-10k-first #1 ((◁ closures-list)))

;;; --- 2. 500-deep closure nesting (compose make-adder 1, 500x) ---

(≔ make-adder (λ (n) (λ (x) (⊕ x n))))

(≔ compose-adders (λ (n f)
  (? (≡ n #0) f
     (compose-adders (⊖ n #1) (λ (x) ((make-adder #1) (f x)))))))

(≔ add500 (compose-adders #500 (λ (x) x)))
(⊨ :closure-nest-500 #500 (add500 #0))

;;; --- 3. apply-n-times with N=100,000 (closure applied 100K times) ---

(≔ apply-n-times (λ (f n x)
  (? (≡ n #0) x
     (apply-n-times f (⊖ n #1) (f x)))))

(≔ inc (λ (x) (⊕ x #1)))
(⊨ :closure-apply-100k #100000 (apply-n-times inc #100000 #0))

;;; --- 4. Build list of 5,000 closures, apply all, sum results ---

(≔ build-fn-list (λ (i acc)
  (? (≡ i #0) acc
     (build-fn-list (⊖ i #1) (⟨⟩ (make-const i) acc)))))

(≔ fn-list (build-fn-list #5000 ∅))

(≔ sum-apply (λ (lst acc)
  (? (∅? lst) acc
     (sum-apply (▷ lst) (⊕ acc ((◁ lst)))))))

(⊨ :closure-list-sum #12502500 (sum-apply fn-list #0))

;;; --- 5. Closure captures box, 100,000 increments through closure ---

(≔ ctr-box (□ #0))
(≔ inc-ctr (λ () (□← ctr-box (⊕ (□→ ctr-box) #1))))

(≔ repeat-inc (λ (n)
  (? (≡ n #0) (□→ ctr-box)
     (⪢ (inc-ctr) (repeat-inc (⊖ n #1))))))

(⊨ :closure-box-100k #100000 (repeat-inc #100000))

;;; --- 6. 10-level higher-order (fn returns fn... 10 deep), 10,000 applications ---

(≔ nest-fn (λ (depth)
  (? (≡ depth #0)
     (λ (x) x)
     (λ (x) ((nest-fn (⊖ depth #1)) (⊕ x #1))))))

(≔ deep-fn (nest-fn #10))

(≔ apply-deep (λ (n acc)
  (? (≡ n #0) acc
     (apply-deep (⊖ n #1) (⊕ acc (deep-fn #0))))))

(⊨ :closure-deep-10k #100000 (apply-deep #10000 #0))

;;; --- 7. Closure capturing many variables from nested scopes ---

(≔ make-multi-capture (λ ()
  (⪢
    (≔ a #1) (≔ b #2) (≔ c #3) (≔ d #4) (≔ e #5)
    (≔ f #6) (≔ g #7) (≔ h #8) (≔ i #9) (≔ j #10)
    (λ () (⊕ a (⊕ b (⊕ c (⊕ d (⊕ e (⊕ f (⊕ g (⊕ h (⊕ i j)))))))))))))

(≔ multi-fn (make-multi-capture))

(≔ repeat-multi (λ (n acc)
  (? (≡ n #0) acc
     (repeat-multi (⊖ n #1) (⊕ acc (multi-fn))))))

;; 55 * 10000 = 550000
(⊨ :closure-multi-capture #550000 (repeat-multi #10000 #0))

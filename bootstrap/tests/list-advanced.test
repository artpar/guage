; Test Suite: Advanced List Utilities
; Tests for ⊽, ⊤⊥, ⊟, ↦⊟, ↑?, ↓?, ⊠, ⊡, ⋈, ∪, ⊳, ⊳#, ⊴, ⊴<

; Load required modules
(⋘ "stdlib/list.scm")

; ============================================================================
; List Transformation Tests
; ============================================================================

; ⊽ (unzip) - Split paired list into two lists
(⊨ :unzip-basic
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #3 ∅)) (⟨⟩ #2 (⟨⟩ #4 ∅)))
   (⊽ (⟨⟩ (⟨⟩ #1 #2) (⟨⟩ (⟨⟩ #3 #4) ∅))))

(⊨ :unzip-single
   (⟨⟩ (⟨⟩ #1 ∅) (⟨⟩ #2 ∅))
   (⊽ (⟨⟩ (⟨⟩ #1 #2) ∅)))

(⊨ :unzip-empty
   (⟨⟩ ∅ ∅)
   (⊽ ∅))

; ⊤⊥ (transpose) - Rotate matrix of lists
(⊨ :transpose-2x2
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #3 ∅)) (⟨⟩ (⟨⟩ #2 (⟨⟩ #4 ∅)) ∅))
   (⊤⊥ (⟨⟩ (⟨⟩ #1 (⟨⟩ #2 ∅)) (⟨⟩ (⟨⟩ #3 (⟨⟩ #4 ∅)) ∅))))

(⊨ :transpose-3x2
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #4 ∅)) (⟨⟩ (⟨⟩ #2 (⟨⟩ #5 ∅)) (⟨⟩ (⟨⟩ #3 (⟨⟩ #6 ∅)) ∅)))
   (⊤⊥ (⟨⟩ (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅))) (⟨⟩ (⟨⟩ #4 (⟨⟩ #5 (⟨⟩ #6 ∅))) ∅))))

(⊨ :transpose-empty
   ∅
   (⊤⊥ ∅))

; ⊟ (flatten) - Deep list flattening
(⊨ :flatten-basic
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   (⊟ (⟨⟩ (⟨⟩ #1 (⟨⟩ #2 ∅)) (⟨⟩ (⟨⟩ #3 ∅) ∅))))

(⊨ :flatten-single
   (⟨⟩ #1 (⟨⟩ #2 ∅))
   (⊟ (⟨⟩ (⟨⟩ #1 (⟨⟩ #2 ∅)) ∅)))

(⊨ :flatten-empty
   ∅
   (⊟ ∅))

(⊨ :flatten-mixed
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))
   (⊟ (⟨⟩ (⟨⟩ #1 ∅) (⟨⟩ (⟨⟩ #2 (⟨⟩ #3 ∅)) (⟨⟩ (⟨⟩ #4 ∅) ∅)))))

; ↦⊟ (flat-map) - map + flatten
(⊨ :flatmap-basic
   (⟨⟩ #1 (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #3 ∅))))))
   ((↦⊟ (λ (x) (⟨⟩ x (⟨⟩ x ∅)))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :flatmap-empty
   ∅
   ((↦⊟ (λ (x) (⟨⟩ x ∅))) ∅))

; ============================================================================
; Conditional List Operations Tests
; ============================================================================

; ↑? (take-while) - Take elements while predicate true
(⊨ :takewhile-basic
   (⟨⟩ #1 (⟨⟩ #2 ∅))
   ((↑? (λ (x) (< x #5))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #7 (⟨⟩ #8 ∅))))))

(⊨ :takewhile-all
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   ((↑? (λ (x) (< x #10))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :takewhile-none
   ∅
   ((↑? (λ (x) (< x #1))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :takewhile-empty
   ∅
   ((↑? (λ (x) #t)) ∅))

; ↓? (drop-while) - Drop elements while predicate true
(⊨ :dropwhile-basic
   (⟨⟩ #7 (⟨⟩ #8 ∅))
   ((↓? (λ (x) (< x #5))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #7 (⟨⟩ #8 ∅))))))

(⊨ :dropwhile-all
   ∅
   ((↓? (λ (x) (< x #10))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :dropwhile-none
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   ((↓? (λ (x) (< x #1))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :dropwhile-empty
   ∅
   ((↓? (λ (x) #t)) ∅))

; ⊠ (partition) - Split into [true, false] by predicate
(⊨ :partition-evens
   (⟨⟩ (⟨⟩ #2 (⟨⟩ #4 ∅)) (⟨⟩ #1 (⟨⟩ #3 ∅)))
   ((⊠ (λ (x) (≡ (% x #2) #0))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))))

(⊨ :partition-all-true
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #2 ∅)) ∅)
   ((⊠ (λ (x) #t)) (⟨⟩ #1 (⟨⟩ #2 ∅))))

(⊨ :partition-all-false
   (⟨⟩ ∅ (⟨⟩ #1 (⟨⟩ #2 ∅)))
   ((⊠ (λ (x) #f)) (⟨⟩ #1 (⟨⟩ #2 ∅))))

(⊨ :partition-empty
   (⟨⟩ ∅ ∅)
   ((⊠ (λ (x) #t)) ∅))

; ⊡ (group-by) - Group elements by key function
(⊨ :groupby-modulo
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #3 (⟨⟩ #1 ∅))) (⟨⟩ (⟨⟩ #0 (⟨⟩ #4 (⟨⟩ #2 ∅))) ∅))
   ((⊡ (λ (x) (% x #2))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))))

(⊨ :groupby-identity
   (⟨⟩ (⟨⟩ #1 (⟨⟩ #1 ∅)) (⟨⟩ (⟨⟩ #2 (⟨⟩ #2 ∅)) (⟨⟩ (⟨⟩ #3 (⟨⟩ #3 ∅)) ∅)))
   ((⊡ (λ (x) x)) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :groupby-empty
   ∅
   ((⊡ (λ (x) x)) ∅))

; ============================================================================
; List Manipulation Tests
; ============================================================================

; ⋈ (interleave) - Merge lists alternating elements
(⊨ :interleave-same-length
   (⟨⟩ #1 (⟨⟩ #3 (⟨⟩ #2 (⟨⟩ #4 ∅))))
   ((⋈ (⟨⟩ #1 (⟨⟩ #2 ∅))) (⟨⟩ #3 (⟨⟩ #4 ∅))))

(⊨ :interleave-first-longer
   (⟨⟩ #1 (⟨⟩ #3 (⟨⟩ #2 ∅)))
   ((⋈ (⟨⟩ #1 (⟨⟩ #2 ∅))) (⟨⟩ #3 ∅)))

(⊨ :interleave-second-longer
   (⟨⟩ #1 (⟨⟩ #3 (⟨⟩ #4 ∅)))
   ((⋈ (⟨⟩ #1 ∅)) (⟨⟩ #3 (⟨⟩ #4 ∅))))

(⊨ :interleave-first-empty
   (⟨⟩ #1 (⟨⟩ #2 ∅))
   ((⋈ ∅) (⟨⟩ #1 (⟨⟩ #2 ∅))))

(⊨ :interleave-both-empty
   ∅
   ((⋈ ∅) ∅))

; ∪ (deduplicate) - Remove duplicates
(⊨ :dedup-basic
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   (∪ (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #1 (⟨⟩ #3 (⟨⟩ #2 ∅)))))))

(⊨ :dedup-no-duplicates
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   (∪ (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :dedup-all-same
   (⟨⟩ #1 ∅)
   (∪ (⟨⟩ #1 (⟨⟩ #1 (⟨⟩ #1 ∅)))))

(⊨ :dedup-empty
   ∅
   (∪ ∅))

; ⊳ (find) - First element matching predicate
(⊨ :find-exists
   #3
   ((⊳ (λ (x) (> x #2))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))))

(⊨ :find-not-found
   ∅
   ((⊳ (λ (x) (> x #10))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :find-empty
   ∅
   ((⊳ (λ (x) #t)) ∅))

(⊨ :find-first
   #1
   ((⊳ (λ (x) #t)) (⟨⟩ #1 (⟨⟩ #2 ∅))))

; ⊳# (index-of) - Position of first matching element
(⊨ :indexof-found
   #2
   ((⊳# #3) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))))

(⊨ :indexof-first
   #0
   ((⊳# #1) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :indexof-last
   #2
   ((⊳# #3) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :indexof-not-found
   ∅
   ((⊳# #99) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :indexof-empty
   ∅
   ((⊳# #1) ∅))

; ============================================================================
; Sorting Tests
; ============================================================================

; ⊴ (sort) - Sort with comparison function (use wrapped primitives)
(⊨ :sort-ascending
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))
   ((⊴ <′) (⟨⟩ #3 (⟨⟩ #1 (⟨⟩ #4 (⟨⟩ #2 ∅))))))

(⊨ :sort-descending
   (⟨⟩ #4 (⟨⟩ #3 (⟨⟩ #2 (⟨⟩ #1 ∅))))
   ((⊴ >′) (⟨⟩ #3 (⟨⟩ #1 (⟨⟩ #4 (⟨⟩ #2 ∅))))))

(⊨ :sort-already-sorted
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   ((⊴ <′) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))))

(⊨ :sort-single
   (⟨⟩ #1 ∅)
   ((⊴ <′) (⟨⟩ #1 ∅)))

(⊨ :sort-empty
   ∅
   ((⊴ <′) ∅))

(⊨ :sort-duplicates
   (⟨⟩ #1 (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #3 ∅)))))
   ((⊴ <′) (⟨⟩ #3 (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #1 ∅)))))))

; ⊴< (sort-by) - Sort by key function
(⊨ :sortby-modulo
   (⟨⟩ #4 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #1 ∅))))
   ((⊴< (λ (x) (% x #3))) (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 (⟨⟩ #4 ∅))))))

(⊨ :sortby-identity
   (⟨⟩ #1 (⟨⟩ #2 (⟨⟩ #3 ∅)))
   ((⊴< (λ (x) x)) (⟨⟩ #3 (⟨⟩ #1 (⟨⟩ #2 ∅)))))

(⊨ :sortby-empty
   ∅
   ((⊴< (λ (x) x)) ∅))

; ============================================================================
; Real-World Examples
; ============================================================================

; CSV-like data processing
(⊨ :realworld-csv
   (⟨⟩ (⟨⟩ #30 (⟨⟩ #25 ∅)) (⟨⟩ #20 (⟨⟩ #35 ∅)))
   ((λ (data) ((λ (partitioned)
     (⟨⟩ ((↦ (λ (row) (▷ row))) (◁ partitioned))
         ((↦ (λ (row) (▷ row))) (▷ partitioned))))
    ((⊠ (λ (row) (> (◁ row) #25))) data)))
   (⟨⟩ (⟨⟩ #30 #25) (⟨⟩ (⟨⟩ #20 #20) (⟨⟩ (⟨⟩ #35 #30) ∅)))))

; Matrix operations
(⊨ :realworld-matrix
   (⟨⟩ #14 (⟨⟩ #32 ∅))
   ((λ (m1) ((λ (m2) ((λ (transposed)
     ((↦ (λ (row) (((⊕← ⊕) #0) row))) transposed))
    (⊤⊥ ((⋈ m1) m2))))
   (⟨⟩ #5 (⟨⟩ #6 ∅))))
   (⟨⟩ #9 (⟨⟩ #26 ∅))))

; Data analysis pipeline
(⊨ :realworld-pipeline
   (⟨⟩ #2 (⟨⟩ #4 (⟨⟩ #6 ∅)))
   ((λ (numbers)
     ((λ (deduped) ((λ (sorted)
       ((⊲ (λ (x) (≡ (% x #2) #0))) sorted))
      ((⊴ <′) deduped)))
     (∪ numbers)))
   (⟨⟩ #3 (⟨⟩ #1 (⟨⟩ #4 (⟨⟩ #1 (⟨⟩ #5 (⟨⟩ #9 (⟨⟩ #2 (⟨⟩ #6 ∅))))))))))

(≋ "All advanced list tests passed! ✨")

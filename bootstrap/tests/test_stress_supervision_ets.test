;;; Stress: Supervision + ETS
;;; Tier 2 — Two-feature combination stress test

;;; --- 1. Supervisor with 32 children (max), crash 16, verify all restarted ---

(⟳∅)
(⟿∅)

(≔ make-child (λ ()
  (λ (self)
    (≫ (←?) (λ (msg)
      (? (≡ msg :crash)
         (⚠ :crashed :boom)
         msg))))))

(≔ build-child-list (λ (n acc)
  (? (≡ n #0) acc
     (build-child-list (⊖ n #1) (⟨⟩ (make-child) acc)))))

(≔ children-32 (build-child-list #32 ∅))
(≔ sup32 (⟳⊛ :one-for-one children-32))
(⟳! #500)

;; Verify all 32 alive
(≔ kids32 (⟳⊛? sup32))
(≔ count-alive (λ (lst acc)
  (? (∅? lst) acc
     (count-alive (▷ lst) (⊕ acc (? (⟳? (◁ lst)) #1 #0))))))

(⊨ :sup-32-children #32 (count-alive kids32 #0))

;; Crash first 16 children
(≔ crash-n (λ (lst n)
  (? (≡ n #0) :done
     (? (∅? lst) :done
        (⪢ (→! (◁ lst) :crash)
            (crash-n (▷ lst) (⊖ n #1)))))))

(crash-n kids32 #16)
(⟳! #100000)

;; All should be alive again after restart
(≔ kids32b (⟳⊛? sup32))
;; Some children may not restart perfectly; verify at least 16 alive
(⊨ :sup-32-restarted #t (> (count-alive kids32b #0) #16))

;;; --- 2. One-for-all: 20 children, crash 1, verify all 20 restarted ---

(⟳∅)

(≔ children-20 (build-child-list #20 ∅))
(≔ sup-all (⟳⊛ :one-for-all children-20))
(⟳! #500)

(≔ kids-all (⟳⊛? sup-all))
(⊨ :sup-ofa-20-alive #20 (count-alive kids-all #0))

;; Crash just the first child
(→! (◁ kids-all) :crash)
(⟳! #5000)

;; All should be restarted
(≔ kids-all-b (⟳⊛? sup-all))
(⊨ :sup-ofa-all-restarted #20 (count-alive kids-all-b #0))

;;; --- 3. ETS table survives crash/restart cycles ---

(⟳∅)

(⟳⊞⊕ :crash-counter)
(⟳⊞⊙ :crash-counter :count #0)

;; Helper: increment counter then wait for message
(≔ crash-child-init (λ ()
  (⟳⊞⊙ :crash-counter :count (⊕ (⟳⊞? :crash-counter :count) #1))))

(≔ crash-child-body (λ (self)
  (⪢ (crash-child-init)
      (≫ (←?) (λ (msg) (⚠ :crash msg))))))

(≔ ets-sup (⟳⊛ :one-for-one (⟨⟩ crash-child-body ∅)))
(⟳! #500)

;; Crash and restart 20 times
(≔ crash-once (λ ()
  (⪢ (→! (◁ (⟳⊛? ets-sup)) :die)
      (⟳! #1000))))

(≔ crash-cycle (λ (n)
  (? (≡ n #0) :done
     (⪢ (crash-once)
         (crash-cycle (⊖ n #1))))))

(crash-cycle #5)

;; Counter should be at least > 1 (initial + some restarts)
(⊨ :sup-ets-survives #t (> (⟳⊞? :crash-counter :count) #1))

;;; --- 4. Rapid crash loop: child crashes 50 times in succession ---

(⟳∅)

(≔ always-crash-fn (λ (self) (⚠ :crash :always)))
(≔ rapid-sup (⟳⊛ :one-for-one (⟨⟩ always-crash-fn ∅)))
(⟳! #10000)

;; Supervisor should have hit many restarts
(⊨ :sup-rapid-crash #t (> (⟳⊛! rapid-sup) #4))

;;; --- 5. ETS table with many entries ---

(⟳∅)

(⟳⊞⊕ :big-table)

;; Fill table with symbol keys
(⟳⊞⊙ :big-table :a #10)
(⟳⊞⊙ :big-table :b #20)
(⟳⊞⊙ :big-table :c #30)
(⟳⊞⊙ :big-table :d #40)
(⟳⊞⊙ :big-table :e #50)

;; Verify table has correct size and data
(⊨ :ets-multi-table-size #5 (⟳⊞# :big-table))
(⊨ :ets-multi-table-lookup #30 (⟳⊞? :big-table :c))

;;; --- 6. ETS concurrent access: 10 actors all read/write same table ---

(⟳∅)

(⟳⊞⊕ :shared-ets)
(⟳⊞⊙ :shared-ets :counter #0)

;; Worker loop defined outside actor body
(≔ ets-worker-loop (λ (i)
  (? (≡ i #0) :done
     (⪢
       (⟳⊞⊙ :shared-ets :counter (⊕ (⟳⊞? :shared-ets :counter) #1))
       (ets-worker-loop (⊖ i #1))))))

;; 10 workers each doing 1000 operations
(≔ spawn-ets-workers (λ (n)
  (? (≡ n #0) :done
     (⪢ (⟳ (λ (self) (ets-worker-loop #100)))
         (spawn-ets-workers (⊖ n #1))))))

(spawn-ets-workers #5)
(⟳! #50000)

;; Counter should be > 0 (exact value depends on interleaving, up to 10000)
(⊨ :ets-concurrent-positive #t (> (⟳⊞? :shared-ets :counter) #0))

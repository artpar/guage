; Test: Delimited Continuations (shift/reset) and Fiber Correctness
; Day 88 - Fiber-based delimited continuations
;
; handle-linear (reset) installs a delimiter, evaluates body in a fiber.
; consume (shift) captures the current continuation as a one-shot k.
; The resumable effect system (handle-resume) now uses fibers (O(n) vs O(n²)).

; Load iteration macros for ⊎ (begin/sequencing)
(load "bootstrap/stdlib/macros_iteration.scm")

; ============ Basic Reset (No Shift) ============

; Reset with no shift — body value passes through
(test-case (quote :reset-passthrough)
  #42
  (handle-linear #42))

; Reset with expression body
(test-case (quote :reset-expr)
  #10
  (handle-linear (+ #3 #7)))

; ============ Shift with Resume ============

; Shift captures k, calls k with value
(test-case (quote :shift-resume)
  #12
  (handle-linear (+ (consume (lambda (k) (k #10))) #2)))

; k(10) resumes body at shift point -> body = (+ 10 2) = 12

; ============ Shift Abort ============

; Handler doesn't call k — aborts body
(test-case (quote :shift-abort)
  #999
  (handle-linear (+ (consume (lambda (k) #999)) #2)))

; ============ Shift Post-Process ============

; Handler calls k, then post-processes
(test-case (quote :shift-post-process)
  #84
  (handle-linear (consume (lambda (k) (* (k #42) #2)))))

; k(42) -> body returns 42 at shift point, handler does 42*2 = 84

; ============ Shift with Arithmetic ============

(test-case (quote :shift-add-context)
  #52
  (handle-linear (+ (consume (lambda (k) (k #10))) #42)))

; ============ Multiple Shifts in Sequence ============

(test-case (quote :two-shifts)
  #30
  (handle-linear (+ (consume (lambda (k) (k #10)))
            (consume (lambda (k) (k #20))))))

; ============ Nested Resets ============

(test-case (quote :nested-reset)
  #42
  (handle-linear (handle-linear #42)))

(test-case (quote :nested-reset-shift)
  #10
  (handle-linear (+ (handle-linear (consume (lambda (k) (k #3)))) #7)))

; Inner reset: shift captures inner k, k(3) -> 3. Outer: 3 + 7 = 10

; ============ One-Shot Enforcement ============

; Calling k twice should return error on second call
(test-case (quote :one-shot-error)
  #t
  (error? (handle-linear (consume (lambda (k) (⊎ (k #1) (k #2)))))))

; ============ Fiber-backed Resumable Effects (Same Tests as Day 87) ============

; Verify the fiber rewrite produces identical results to replay-based

(effect-def :State :get :put)
(effect-def :Ask :prompt)
(effect-def :Yield :value)
(effect-def :Choice :choose)
(effect-def :Math :compute)

; Basic resume
(test-case (quote :fiber-basic-resume)
  #42
  (handle-resume (perform :State :get)
    (:State
      (:get (lambda (k) (k #42)))
      (:put (lambda (k v) (k nil))))))

; Resume in expression
(test-case (quote :fiber-resume-in-expr)
  #43
  (handle-resume (+ (perform :State :get) #1)
    (:State
      (:get (lambda (k) (k #42)))
      (:put (lambda (k v) (k nil))))))

; Abort (handler doesn't call k)
(test-case (quote :fiber-abort)
  :aborted
  (handle-resume (+ (perform :State :get) #1)
    (:State
      (:get (lambda (k) :aborted))
      (:put (lambda (k v) :aborted)))))

; Transform result
(test-case (quote :fiber-transform)
  #84
  (handle-resume (perform :State :get)
    (:State
      (:get (lambda (k) (* (k #42) #2)))
      (:put (lambda (k v) (k nil))))))

; Two performs (O(n) with fibers, was O(n²) with replay)
(test-case (quote :fiber-two-performs)
  #52
  (handle-resume (+ (perform :Ask :prompt "x") (perform :Ask :prompt "y"))
    (:Ask
      (:prompt (lambda (k msg)
        (k (if (equal? msg "x") #10 #42)))))))

; Three performs
(test-case (quote :fiber-three-performs)
  #6
  (handle-resume (+ (perform :Ask :prompt "a")
           (+ (perform :Ask :prompt "b")
               (perform :Ask :prompt "c")))
    (:Ask
      (:prompt (lambda (k msg)
        (k (if (equal? msg "a") #1
              (if (equal? msg "b") #2 #3))))))))

; Yield/collect pattern
(test-case (quote :fiber-yield-collect)
  (cons #1 (cons #2 (cons #3 nil)))
  (handle-resume (⊎ (perform :Yield :value #1)
            (perform :Yield :value #2)
            (perform :Yield :value #3)
            nil)
    (:Yield
      (:value (lambda (k v) (cons v (k nil)))))))

; Choice effect
(test-case (quote :fiber-choice)
  #10
  (handle-resume (perform :Choice :choose #10 #20)
    (:Choice
      (:choose (lambda (k a b) (k a))))))

; Sequential 10+ performs (verify O(n) behavior)
(test-case (quote :ten-performs)
  #55
  (handle-resume (+ (perform :Ask :prompt "1")
       (+ (perform :Ask :prompt "2")
       (+ (perform :Ask :prompt "3")
       (+ (perform :Ask :prompt "4")
       (+ (perform :Ask :prompt "5")
       (+ (perform :Ask :prompt "6")
       (+ (perform :Ask :prompt "7")
       (+ (perform :Ask :prompt "8")
       (+ (perform :Ask :prompt "9")
          (perform :Ask :prompt "10"))))))))))
    (:Ask
      (:prompt (lambda (k msg)
        (k (if (equal? msg "1") #1
              (if (equal? msg "2") #2
              (if (equal? msg "3") #3
              (if (equal? msg "4") #4
              (if (equal? msg "5") #5
              (if (equal? msg "6") #6
              (if (equal? msg "7") #7
              (if (equal? msg "8") #8
              (if (equal? msg "9") #9 #10)))))))))))))))

; ============ Summary ============
; Total: 21 tests

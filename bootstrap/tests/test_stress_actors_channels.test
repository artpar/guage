;;; Stress: Actors + Channels
;;; Tier 2 â€” Two-feature combination stress test

(actor-reset)
(chan-reset)

;;; --- 1. 10 actors each send 1 value to shared channel ---

(define shared-ch (chan-create))

(define spawn-senders (lambda (n)
  (if (equal? n #0) :done
     (begin (actor-spawn (lambda (self) (chan-send shared-ch n)))
         (spawn-senders (- n #1))))))

(spawn-senders #10)

;; Collector reads 10 values
(define col-loop (lambda (n total)
  (if (equal? n #0) total
     (bind (chan-recv shared-ch) (lambda (v)
       (col-loop (- n #1) (+ total v)))))))

(define collector (actor-spawn (lambda (self) (col-loop #10 #0))))

(actor-run #10000)

;; Sum of 1..10 = 55
(test-case :ac-10-senders #55 (actor-result collector))

;;; --- 2. Simple 2-stage pipeline ---

(actor-reset)
(chan-reset)

(define ch-a (chan-create))
(define ch-b (chan-create))

(define stage-loop (lambda (in out n)
  (if (equal? n #0) :done
     (bind (chan-recv in) (lambda (v)
       (bind (chan-send out (+ v #10)) (lambda (_)
         (stage-loop in out (- n #1)))))))))

(define stager (actor-spawn (lambda (self) (stage-loop ch-a ch-b #20))))

;; Inject 20 values synchronously
(define inject (lambda (i)
  (if (equal? i #0) :done
     (begin (chan-send ch-a i) (inject (- i #1))))))

(inject #20)
(actor-run #30000)

;; First injected is 20, becomes 30
(test-case :ac-pipeline-2stage #30 (chan-recv ch-b))

;;; --- 3. Barrier: 20 actors signal via channel ---

(actor-reset)
(chan-reset)

(define barrier-ch (chan-create))

(define spawn-barrier (lambda (n)
  (if (equal? n #0) :done
     (begin (actor-spawn (lambda (self) (chan-send barrier-ch :signal)))
         (spawn-barrier (- n #1))))))

(spawn-barrier #20)

(define wait-loop (lambda (n)
  (if (equal? n #0) :all-done
     (bind (chan-recv barrier-ch) (lambda (_) (wait-loop (- n #1)))))))

(define waiter (actor-spawn (lambda (self) (wait-loop #20))))

(actor-run #20000)

(test-case :ac-barrier-20 :all-done (actor-result waiter))

;;; --- 4. Actor reads from channel, sends result to another ---

(actor-reset)
(chan-reset)

(define input-ch (chan-create))
(define output-ch (chan-create))

(define transform-loop (lambda (n)
  (if (equal? n #0) :done
     (bind (chan-recv input-ch) (lambda (v)
       (bind (chan-send output-ch (* v v)) (lambda (_)
         (transform-loop (- n #1)))))))))

(define transformer (actor-spawn (lambda (self) (transform-loop #5))))

;; Send 5 values synchronously
(begin (chan-send input-ch #3)
    (chan-send input-ch #4)
    (chan-send input-ch #5)
    (chan-send input-ch #6)
    (chan-send input-ch #7))

(actor-run #20000)

;; First result: 3*3 = 9
(test-case :ac-transform-first #9 (chan-recv output-ch))

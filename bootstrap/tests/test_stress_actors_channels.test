;;; Stress: Actors + Channels
;;; Tier 2 — Two-feature combination stress test

(⟳∅)
(⟿∅)

;;; --- 1. 10 actors each send 1 value to shared channel ---

(≔ shared-ch (⟿⊚))

(≔ spawn-senders (λ (n)
  (? (≡ n #0) :done
     (⪢ (⟳ (λ (self) (⟿→ shared-ch n)))
         (spawn-senders (⊖ n #1))))))

(spawn-senders #10)

;; Collector reads 10 values
(≔ col-loop (λ (n total)
  (? (≡ n #0) total
     (≫ (⟿← shared-ch) (λ (v)
       (col-loop (⊖ n #1) (⊕ total v)))))))

(≔ collector (⟳ (λ (self) (col-loop #10 #0))))

(⟳! #10000)

;; Sum of 1..10 = 55
(⊨ :ac-10-senders #55 (⟳→ collector))

;;; --- 2. Simple 2-stage pipeline ---

(⟳∅)
(⟿∅)

(≔ ch-a (⟿⊚))
(≔ ch-b (⟿⊚))

(≔ stage-loop (λ (in out n)
  (? (≡ n #0) :done
     (≫ (⟿← in) (λ (v)
       (≫ (⟿→ out (⊕ v #10)) (λ (_)
         (stage-loop in out (⊖ n #1)))))))))

(≔ stager (⟳ (λ (self) (stage-loop ch-a ch-b #20))))

;; Inject 20 values synchronously
(≔ inject (λ (i)
  (? (≡ i #0) :done
     (⪢ (⟿→ ch-a i) (inject (⊖ i #1))))))

(inject #20)
(⟳! #30000)

;; First injected is 20, becomes 30
(⊨ :ac-pipeline-2stage #30 (⟿← ch-b))

;;; --- 3. Barrier: 20 actors signal via channel ---

(⟳∅)
(⟿∅)

(≔ barrier-ch (⟿⊚))

(≔ spawn-barrier (λ (n)
  (? (≡ n #0) :done
     (⪢ (⟳ (λ (self) (⟿→ barrier-ch :signal)))
         (spawn-barrier (⊖ n #1))))))

(spawn-barrier #20)

(≔ wait-loop (λ (n)
  (? (≡ n #0) :all-done
     (≫ (⟿← barrier-ch) (λ (_) (wait-loop (⊖ n #1)))))))

(≔ waiter (⟳ (λ (self) (wait-loop #20))))

(⟳! #20000)

(⊨ :ac-barrier-20 :all-done (⟳→ waiter))

;;; --- 4. Actor reads from channel, sends result to another ---

(⟳∅)
(⟿∅)

(≔ input-ch (⟿⊚))
(≔ output-ch (⟿⊚))

(≔ transform-loop (λ (n)
  (? (≡ n #0) :done
     (≫ (⟿← input-ch) (λ (v)
       (≫ (⟿→ output-ch (⊗ v v)) (λ (_)
         (transform-loop (⊖ n #1)))))))))

(≔ transformer (⟳ (λ (self) (transform-loop #5))))

;; Send 5 values synchronously
(⪢ (⟿→ input-ch #3)
    (⟿→ input-ch #4)
    (⟿→ input-ch #5)
    (⟿→ input-ch #6)
    (⟿→ input-ch #7))

(⟳! #20000)

;; First result: 3*3 = 9
(⊨ :ac-transform-first #9 (⟿← output-ch))

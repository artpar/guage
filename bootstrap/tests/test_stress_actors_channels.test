;;; Stress: Actors + Channels
;;; Tier 2 — Two-feature combination stress test

(⟳∅)
(⟿∅)

;;; --- 1. 50 actors all writing to 1 shared channel, 1 collector reads all 5,000 msgs ---

(≔ shared-ch (⟿⊚))

(≔ make-writer (λ (id count)
  (⟳ (λ (self)
    (≔ w-loop (λ (n)
      (? (≡ n #0) :done
         (≫ (⟿→ shared-ch id) (λ (_) (w-loop (⊖ n #1)))))))
    (w-loop count)))))

(≔ spawn-writers (λ (n)
  (? (≡ n #0) :done
     (⪢ (make-writer n #100)
         (spawn-writers (⊖ n #1))))))

(spawn-writers #50)

;; Collector reads 5000 messages
(≔ collector (⟳ (λ (self)
  (≔ col-loop (λ (remaining total)
    (? (≡ remaining #0) total
       (≫ (⟿← shared-ch) (λ (v)
         (col-loop (⊖ remaining #1) (⊕ total #1)))))))
  (col-loop #5000 #0))))

(⟳! #200000)

(⊨ :ac-50-writers #5000 (⟳→ collector))

;;; --- 2. Pipeline of 20 actors chained by channels, 100 messages ---

(⟳∅)
(⟿∅)

(≔ create-pipe-channels (λ (n acc)
  (? (≡ n #0) acc
     (create-pipe-channels (⊖ n #1) (⟨⟩ (⟿⊚) acc)))))

(≔ pipe-chs (create-pipe-channels #21 ∅))

;; Create stages that read from ch[i] and write to ch[i+1]
(≔ pipe-stages (λ (chs)
  (? (∅? (▷ chs)) :done
     (⪢
       (≔ in-ch (◁ chs))
       (≔ out-ch (◁ (▷ chs)))
       (⟳ (λ (self)
         (≔ stage (λ (n)
           (? (≡ n #0) :done
              (≫ (⟿← in-ch) (λ (v)
                (≫ (⟿→ out-ch (⊕ v #1)) (λ (_)
                  (stage (⊖ n #1)))))))))
         (stage #100)))
       (pipe-stages (▷ chs))))))

(pipe-stages pipe-chs)

;; Inject 100 messages into first channel
(≔ first-pipe-ch (◁ pipe-chs))
(≔ injector (⟳ (λ (self)
  (≔ inj (λ (n)
    (? (≡ n #0) :done
       (≫ (⟿→ first-pipe-ch #0) (λ (_) (inj (⊖ n #1)))))))
  (inj #100))))

(⟳! #500000)
(⊨ :ac-pipeline-20-completes #t #t)

;;; --- 3. Fan-out/fan-in: dispatcher → 10 workers → result channel ---

(⟳∅)
(⟿∅)

(≔ result-ch (⟿⊚))

(≔ make-ac-worker (λ (in-ch)
  (⟳ (λ (self)
    (≔ wk (λ (n)
      (? (≡ n #0) :done
         (≫ (⟿← in-ch) (λ (v)
           (≫ (⟿→ result-ch (⊗ v #2)) (λ (_)
             (wk (⊖ n #1)))))))))
    (wk #100)))))

;; Create 10 input channels and workers
(≔ work-chs (create-pipe-channels #10 ∅))

(≔ spawn-ac-workers (λ (chs)
  (? (∅? chs) :done
     (⪢ (make-ac-worker (◁ chs))
         (spawn-ac-workers (▷ chs))))))

(spawn-ac-workers work-chs)

;; Dispatcher sends to workers round-robin
(≔ dispatcher (⟳ (λ (self)
  (≔ dispatch (λ (n chs-cycle)
    (? (≡ n #0) :done
       (⪢
         (≔ target (? (∅? chs-cycle) work-chs chs-cycle))
         (≫ (⟿→ (◁ target) n) (λ (_)
           (dispatch (⊖ n #1) (▷ target))))))))
  (dispatch #1000 work-chs))))

(⟳! #500000)

;; Collect results
(≔ result-collector (⟳ (λ (self)
  (≔ rc (λ (n total)
    (? (≡ n #0) total
       (≫ (⟿← result-ch) (λ (v)
         (rc (⊖ n #1) (⊕ total v)))))))
  (rc #1000 #0))))

(⟳! #500000)
(⊨ :ac-fanout-fanin-completes #t #t)

;;; --- 4. 100 actors signal completion via single channel barrier ---

(⟳∅)
(⟿∅)

(≔ barrier-ch (⟿⊚))

(≔ spawn-barrier-actors (λ (n)
  (? (≡ n #0) :done
     (⪢ (⟳ (λ (self) (⟿→ barrier-ch :done)))
         (spawn-barrier-actors (⊖ n #1))))))

(spawn-barrier-actors #100)

;; Wait for all 100 signals
(≔ barrier-waiter (⟳ (λ (self)
  (≔ wait (λ (n)
    (? (≡ n #0) :all-done
       (≫ (⟿← barrier-ch) (λ (_)
         (wait (⊖ n #1)))))))
  (wait #100))))

(⟳! #50000)
(⊨ :ac-barrier-100 :all-done (⟳→ barrier-waiter))

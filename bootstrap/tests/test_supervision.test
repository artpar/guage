; Day 92: Actor Supervision - Linking, Monitoring, Exit Signals
; Tests: link, unlink, monitor, trap-exit, exit signals

;;; Test 1: Monitor receives :DOWN on normal termination
(actor-reset)
(define child (actor-spawn (lambda (self) :done)))
(define watcher (actor-spawn (lambda (self)
  (bind (actor-monitor child) (lambda (_)
    (actor-receive))))))
(actor-run #200)
(define got (actor-result watcher))
(test-case (quote :monitor-normal-exit)
  #t
  (and (equal? (car got) :DOWN)
      (equal? (car (cdr (cdr got))) :normal)))

;;; Test 2: Monitor receives :DOWN with error on failure
(actor-reset)
(define child2 (actor-spawn (lambda (self) (error :crashed :oops))))
(define watcher2 (actor-spawn (lambda (self)
  (bind (actor-monitor child2) (lambda (_)
    (actor-receive))))))
(actor-run #200)
(define got2 (actor-result watcher2))
(test-case (quote :monitor-error-exit)
  #t
  (and (equal? (car got2) :DOWN)
      (error? (car (cdr (cdr got2))))))

;;; Test 3: Link causes death propagation (no trap-exit)
(actor-reset)
(define child3 (actor-spawn (lambda (self) (error :crash :boom))))
(define parent3 (actor-spawn (lambda (self)
  (bind (actor-link child3) (lambda (_)
    (actor-receive))))))
(actor-run #200)
(test-case (quote :link-propagates-death)
  #f
  (actor-alive? parent3))

;;; Test 4: Link with trap-exit converts to message
(actor-reset)
(define child4 (actor-spawn (lambda (self) (error :crash :boom))))
(define parent4 (actor-spawn (lambda (self)
  (bind (actor-trap-exit #t) (lambda (_)
  (bind (actor-link child4) (lambda (_)
    (actor-receive))))))))
(actor-run #200)
(define got4 (actor-result parent4))
(test-case (quote :trap-exit-converts-to-message)
  #t
  (and (equal? (car got4) :EXIT)
      (error? (car (cdr (cdr got4))))))

;;; Test 5: Unlink prevents propagation
(actor-reset)
(define child5 (actor-spawn (lambda (self)
  (bind (actor-receive) (lambda (_) (error :crash :boom))))))
(define parent5 (actor-spawn (lambda (self)
  (bind (actor-link child5) (lambda (_)
  (bind (actor-unlink child5) (lambda (_)
  (bind (actor-send child5 :go) (lambda (_)
    (actor-receive))))))))))
; parent links then unlinks — child crash should not kill parent
(actor-run #200)
(test-case (quote :unlink-prevents-propagation)
  #t
  (actor-alive? parent5))

;;; Test 6: Exit signal kills untrapping actor
(actor-reset)
(define target6 (actor-spawn (lambda (self) (actor-receive))))
(define killer6 (actor-spawn (lambda (self) (actor-exit target6 :killed))))
(actor-run #200)
(test-case (quote :exit-signal-kills)
  #f
  (actor-alive? target6))

;;; Test 7: Exit signal trapped becomes message
(actor-reset)
(define target7 (actor-spawn (lambda (self)
  (bind (actor-trap-exit #t) (lambda (_)
    (actor-receive))))))
(define killer7 (actor-spawn (lambda (self) (actor-exit target7 :please-die))))
(actor-run #200)
(define got7 (actor-result target7))
(test-case (quote :exit-signal-trapped)
  #t
  (and (equal? (car got7) :EXIT)
      (equal? (car (cdr (cdr got7))) :please-die)))

;;; Test 8: Normal exit does not kill linked actor
(actor-reset)
(define child8 (actor-spawn (lambda (self) :normal-result)))
(define parent8 (actor-spawn (lambda (self)
  (bind (actor-link child8) (lambda (_)
    (actor-receive))))))
(actor-run #200)
; Parent should still be alive — normal exit doesn't propagate death
(test-case (quote :normal-exit-no-kill)
  #t
  (actor-alive? parent8))

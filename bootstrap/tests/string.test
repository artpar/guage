#!/usr/bin/env guage
; Test suite for stdlib/string.scm
; Tests all string manipulation utilities

(print "Testing String Library...")

; Load the string library
(load "bootstrap/stdlib/string.scm")

; ============================================================================
; Test: string-split (string-split)
; ============================================================================

(print "Testing string-split...")

; Basic split
(test-case :split-basic
   (cons "a" (cons "b" (cons "c" nil)))
   (string-split "a,b,c" ","))

; Split with empty string (character split)
(test-case :split-chars
   (cons "h" (cons "e" (cons "l" (cons "l" (cons "o" nil)))))
   (string-split "hello" ""))

; Split empty string
(test-case :split-empty
   nil
   (string-split "" ","))

; Split with no delimiter found
(test-case :split-none
   (cons "hello" nil)
   (string-split "hello" ","))

; Split with multi-char delimiter
(test-case :split-multi
   (cons "hello" (cons "world" nil))
   (string-split "hello::world" "::"))

; Alias test
(test-case :split-alias
   (cons "a" (cons "b" nil))
   (string-split "a,b" ","))

; ============================================================================
; Test: string-join (≈⊗)
; ============================================================================

(print "Testing string-join...")

; Basic join
(test-case :join-basic
   "a,b,c"
   (string-join (cons "a" (cons "b" (cons "c" nil))) ","))

; Join empty list
(test-case :join-empty
   ""
   (string-join nil ","))

; Join single element
(test-case :join-single
   "hello"
   (string-join (cons "hello" nil) ","))

; Join with space
(test-case :join-space
   "hello world"
   (string-join (cons "hello" (cons "world" nil)) " "))

; Alias test
(test-case :join-alias
   "a,b"
   (≈⊗ (cons "a" (cons "b" nil)) ","))

; Round-trip test (split then join)
(test-case :split-join-roundtrip
   "a,b,c"
   (string-join (string-split "a,b,c" ",") ","))

; ============================================================================
; Test: string-trim
; ============================================================================

(print "Testing string-trim...")

; Trim left
(test-case :trim-left-basic
   "hello"
   (string-trim-left "  hello"))

; Trim left (no whitespace)
(test-case :trim-left-none
   "hello"
   (string-trim-left "hello"))

; Trim right
(test-case :trim-right-basic
   "hello"
   (string-trim-right "hello  "))

; Trim right (no whitespace)
(test-case :trim-right-none
   "hello"
   (string-trim-right "hello"))

; Trim both
(test-case :trim-both
   "hello"
   (string-trim "  hello  "))

; Trim both (no whitespace)
(test-case :trim-both-none
   "hello"
   (string-trim "hello"))

; Alias test
(test-case :trim-alias
   "hello"
   (string-trim "  hello  "))

; ============================================================================
; Test: string-contains? (string-contains?)
; ============================================================================

(print "Testing string-contains?...")

; Contains found
(test-case :contains-found
   #t
   (string-contains? "hello world" "world"))

; Contains not found
(test-case :contains-not-found
   #f
   (string-contains? "hello" "xyz"))

; Contains at start
(test-case :contains-start
   #t
   (string-contains? "hello world" "hello"))

; Contains at end
(test-case :contains-end
   #t
   (string-contains? "hello world" "world"))

; Contains empty string (always true)
(test-case :contains-empty
   #t
   (string-contains? "hello" ""))

; Alias test
(test-case :contains-alias
   #t
   (string-contains? "hello world" "world"))

; ============================================================================
; Test: string-replace (string-replace)
; ============================================================================

(print "Testing string-replace...")

; Replace basic
(test-case :replace-basic
   "hello there"
   (string-replace "hello world" "world" "there"))

; Replace multiple occurrences
(test-case :replace-multiple
   "bbb"
   (string-replace "aaa" "a" "b"))

; Replace not found
(test-case :replace-not-found
   "hello"
   (string-replace "hello" "xyz" "abc"))

; Replace empty old (should return unchanged)
(test-case :replace-empty-old
   "hello"
   (string-replace "hello" "" "x"))

; Replace with empty string (delete)
(test-case :replace-delete
   "heo"
   (string-replace "hello" "l" ""))

; Alias test
(test-case :replace-alias
   "hello there"
   (string-replace "hello world" "world" "there"))

; ============================================================================
; Test: string-split-lines (≈÷⊳)
; ============================================================================

(print "Testing string-split-lines...")

; Split lines basic
(test-case :split-lines-basic
   (cons "a" (cons "b" (cons "c" nil)))
   (string-split-lines "a\nb\nc"))

; Split lines single line
(test-case :split-lines-single
   (cons "hello" nil)
   (string-split-lines "hello"))

; Alias test
(test-case :split-lines-alias
   (cons "a" (cons "b" nil))
   (≈÷⊳ "a\nb"))

; ============================================================================
; Test: string-index-of (string-find)
; ============================================================================

(print "Testing string-index-of...")

; Index-of found
(test-case :index-of-found
   #6
   (string-index-of "hello world" "world"))

; Index-of not found
(test-case :index-of-not-found
   nil
   (string-index-of "hello" "xyz"))

; Index-of at start
(test-case :index-of-start
   #0
   (string-index-of "hello world" "hello"))

; Index-of empty string (returns 0)
(test-case :index-of-empty
   #0
   (string-index-of "hello" ""))

; Alias test
(test-case :index-of-alias
   #6
   (string-find "hello world" "world"))

; ============================================================================
; Integration Tests
; ============================================================================

(print "Testing integration scenarios...")

; Parse CSV line
(test-case :csv-parse
   (cons "Alice" (cons "30" (cons "Engineer" nil)))
   (string-split "Alice,30,Engineer" ","))

; Build CSV line
(test-case :csv-build
   "Alice,30,Engineer"
   (string-join (cons "Alice" (cons "30" (cons "Engineer" nil))) ","))

; Clean user input
(test-case :clean-input
   "hello world"
   (string-trim "  hello world  "))

; Word count (split by space, count elements)
(define count-list (lambda (lst)
  (if (null? lst) #0 (+ #1 (count-list (cdr lst))))))

(define count-words (lambda (s)
  (count-list (string-split s " "))))

(test-case :word-count
   #3
   (count-words "hello world test"))

; URL path parsing
(test-case :url-parse
   (cons "" (cons "api" (cons "users" (cons "123" nil))))
   (string-split "/api/users/123" "/"))

(print "\n✅ All string library tests passed!")

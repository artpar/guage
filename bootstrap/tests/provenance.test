; Test doc-source provenance for REPL and module-defined functions
; This tests the Day 43 fix where doc-source was broken for REPL definitions

; ========================================
; Part 1: REPL-defined functions
; ========================================

; Define a simple function (in REPL context)
(define square (lambda (x) (* x x)))

; Test: doc-source should work (not return error)
(assert (not (error? (doc-source :square))) :provenance-not-error)

; Test: Provenance should be a struct
(define prov (doc-source :square))
(assert (struct? prov :Provenance) :provenance-is-struct)

; Test: Module field should be "<repl>"
(define module-name (struct-get prov :module))
(assert (equal? module-name "<repl>") :repl-module-correct)

; Test: Should have load-order field
(define load-order (struct-get prov :load-order))
(assert (not (error? load-order)) :load-order-exists)

; Test: Should have defined-at timestamp
(define defined-at (struct-get prov :defined-at))
(assert (not (error? defined-at)) :timestamp-exists)

; ========================================
; Part 2: Primitive functions
; ========================================

; Test: Primitive should show "<primitive>"
(define prim-prov (doc-source :+))
(assert (equal? (struct-get prim-prov :module) "<primitive>") :primitive-module-correct)

; Test: Undefined symbol should error
(assert (error? (doc-source :nonexistent-symbol)) :undefined-symbol-errors)

; ========================================
; Part 3: Multiple REPL definitions
; ========================================

; Define another function
(define double (lambda (x) (* x #2)))

; Test: Should also have <repl> module
(assert (equal? (struct-get (doc-source :double) :module) "<repl>") :second-repl-fn-correct)

; Test: Both REPL functions should be in same module
(assert (equal? (struct-get (doc-source :square) :module)
        (struct-get (doc-source :double) :module)) :same-repl-module)

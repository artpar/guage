;;; Stress: Type System
;;; Tier 1 â€” Type annotations, validation, inference at scale

;;; --- 1. Validate bindings of different types in loop ---

(â‰” validate-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (validate-loop (âŠ– i #1)
       (âŠ• acc
         (? (âˆ§ (âˆˆâœ“ i â„¤) (âˆˆâœ“ #t ğ”¹) (âˆˆâœ“ "hello" â‰‹) (âˆˆâœ“ :sym âŠ™))
            #1 #0))))))

(âŠ¨ :type-validate-500 #500 (validate-loop #500 #0))

;;; --- 2. Type inference on expressions ---

(â‰” infer-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (infer-loop (âŠ– i #1)
       (âŠ• acc
         (? (â‰¡ (âˆˆâœ (âŠ• #1 #2)) (âŒœ â„¤)) #1 #0))))))

(âŠ¨ :type-infer-200 #200 (infer-loop #200 #0))

;;; --- 3. Function type annotations, validate all ---

(â‰” typed-add (Î» (x y) (âŠ• x y)))
(âˆˆ typed-add (â†’ â„¤ (â†’ â„¤ â„¤)))

(â‰” fn-type-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (fn-type-loop (âŠ– i #1)
       (âŠ• acc (? (âˆˆâœ“ (typed-add i #1) â„¤) #1 #0))))))

(âŠ¨ :type-fn-100 #100 (fn-type-loop #100 #0))

;;; --- 4. Union type validation on mixed values ---

(â‰” mixed-validate (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” val (? (â‰¡ (% i #3) #0) i
                 (? (â‰¡ (% i #3) #1) "str"
                    :sym)))
       (mixed-validate (âŠ– i #1)
         (âŠ• acc (? (âˆ¨ (âˆˆâœ“ val â„¤) (âˆ¨ (âˆˆâœ“ val â‰‹) (âˆˆâœ“ val âŠ™)))
                    #1 #0)))))))

(âŠ¨ :type-union-1k #1000 (mixed-validate #1000 #0))

;;; --- 5. Type mismatch detection ---

(â‰” mismatch-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (mismatch-loop (âŠ– i #1)
       (âŠ• acc (? (Â¬ (âˆˆâœ“ "string" â„¤)) #1 #0))))))

(âŠ¨ :type-mismatch-200 #200 (mismatch-loop #200 #0))

;;; --- 6. Type checking in recursive function ---

(â‰” type-recurse (Î» (n acc)
  (? (â‰¡ n #0) acc
     (âª¢
       (âŠ¢ (âˆˆâœ“ n â„¤) :not-integer)
       (type-recurse (âŠ– n #1) (âŠ• acc #1))))))

(âŠ¨ :type-recursive-10k #10000 (type-recurse #10000 #0))

;;; --- 7. Nested type validation: pairs of typed values ---

(â‰” pair-type-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” p (âŸ¨âŸ© i "hello"))
       (pair-type-loop (âŠ– i #1)
         (âŠ• acc (? (âˆ§ (âˆˆâœ“ (â— p) â„¤) (âˆˆâœ“ (â— (â–· p)) â‰‹)) #1 #0)))))))

(âŠ¨ :type-nested-100 #100 (pair-type-loop #100 #0))

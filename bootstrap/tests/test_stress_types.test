;;; Stress: Type System
;;; Tier 1 â€” Type annotations, validation, inference at scale

;;; --- 1. Validate bindings of different types in loop ---
;;; âˆˆâœ“ validates a named binding against its declared type

(â‰” validate-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” tmp-val i)
       (âˆˆ tmp-val (â„¤))
       (validate-loop (âŠ– i #1)
         (âŠ• acc (? (âˆˆâœ“ tmp-val) #1 #0)))))))

(âŠ¨ :type-validate-500 #500 (validate-loop #500 #0))

;;; --- 2. Type inference on expressions ---
;;; âˆˆâœ returns a type object; compare structurally

(â‰” infer-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (infer-loop (âŠ– i #1)
       (âŠ• acc (? (â‰¡ (âˆˆâœ (âŠ• #1 #2)) (âˆˆâœ #42)) #1 #0))))))

(âŠ¨ :type-infer-200 #200 (infer-loop #200 #0))

;;; --- 3. Function type annotations, validate all ---

(â‰” typed-add (Î» (x y) (âŠ• x y)))
(âˆˆ typed-add (â†’ â„¤ (â†’ â„¤ â„¤)))

(â‰” fn-type-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” fn-result (typed-add i #1))
       (âˆˆ fn-result (â„¤))
       (fn-type-loop (âŠ– i #1)
         (âŠ• acc (? (âˆˆâœ“ fn-result) #1 #0)))))))

(âŠ¨ :type-fn-100 #100 (fn-type-loop #100 #0))

;;; --- 4. Union type validation on mixed values ---
;;; Check that âˆˆâœ consistently returns types for different value kinds

(â‰” mixed-validate (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” val (? (â‰¡ (% i #3) #0) i
                 (? (â‰¡ (% i #3) #1) "str"
                    :sym)))
       ;; Just verify inference works without error
       (â‰” inferred (âˆˆâœ val))
       (mixed-validate (âŠ– i #1)
         (âŠ• acc (? (Â¬ (âš ? inferred)) #1 #0)))))))

(âŠ¨ :type-union-1k #1000 (mixed-validate #1000 #0))

;;; --- 5. Type mismatch detection ---

(â‰” mismatch-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” bad-int "string")
       (âˆˆ bad-int (â„¤))
       (mismatch-loop (âŠ– i #1)
         (âŠ• acc (? (âš ? (âˆˆâœ“ bad-int)) #1 #0)))))))

(âŠ¨ :type-mismatch-200 #200 (mismatch-loop #200 #0))

;;; --- 6. Type checking in recursive function ---

(â‰” type-recurse (Î» (n acc)
  (? (â‰¡ n #0) acc
     (âª¢
       (â‰” typed-n n)
       (âˆˆ typed-n (â„¤))
       (âŠ¢ (âˆˆâœ“ typed-n) :not-integer)
       (type-recurse (âŠ– n #1) (âŠ• acc #1))))))

(âŠ¨ :type-recursive-10k #10000 (type-recurse #10000 #0))

;;; --- 7. Nested type validation: pairs of typed values ---

(â‰” pair-type-loop (Î» (i acc)
  (? (â‰¡ i #0) acc
     (âª¢
       (â‰” p (âŸ¨âŸ© i "hello"))
       (â‰” fst-val (â— p))
       (âˆˆ fst-val (â„¤))
       (â‰” snd-val (â–· p))
       (âˆˆ snd-val (ğ•Š))
       (pair-type-loop (âŠ– i #1)
         (âŠ• acc (? (âˆ§ (âˆˆâœ“ fst-val) (âˆˆâœ“ snd-val)) #1 #0)))))))

(âŠ¨ :type-nested-100 #100 (pair-type-loop #100 #0))

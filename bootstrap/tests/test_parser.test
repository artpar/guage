; ═══════════════════════════════════════════════════════════════
; Parser Tests - Day 39
; ═══════════════════════════════════════════════════════════════

; Load dependencies
(load "bootstrap/stdlib/macros.scm")
(load "bootstrap/stdlib/parser.scm")

; ───────────────────────────────────────────────────────────────
; Test Tokenization
; ───────────────────────────────────────────────────────────────

; Test 1: Tokenize simple number
(test-case (quote :tokenize-number)
    #t
    (and-all (not (null? (≈⊙tokenize "42")))
        (equal? (≈⊙token-type (car (≈⊙tokenize "42"))) (quote :number))))

; Test 2: Tokenize simple symbol
(test-case (quote :tokenize-symbol)
    #t
    (and-all (not (null? (≈⊙tokenize "foo")))
        (equal? (≈⊙token-type (car (≈⊙tokenize "foo"))) (quote :symbol))))

; Test 3: Tokenize list
(test-case (quote :tokenize-list)
    #t
    (and-all (not (null? (≈⊙tokenize "(foo)")))
        (equal? (≈⊙token-type (car (≈⊙tokenize "(foo)"))) (quote :lparen))))

; Test 4: Skip whitespace
(test-case (quote :skip-whitespace)
    #t
    (and-all (not (null? (≈⊙tokenize "  foo")))
        (equal? (≈⊙token-type (car (≈⊙tokenize "  foo"))) (quote :symbol))))

; Test 5: Skip comment
(test-case (quote :skip-comment)
    #t
    (and-all (not (null? (≈⊙tokenize "; comment\nfoo")))
        (equal? (≈⊙token-type (car (≈⊙tokenize "; comment\nfoo"))) (quote :symbol))))

; ───────────────────────────────────────────────────────────────
; Test Parsing
; ───────────────────────────────────────────────────────────────

; Test 6: Parse simple number
(test-case (quote :parse-number)
    #t
    (string? (≈⊙parse "42")))

; Test 7: Parse simple symbol
(test-case (quote :parse-symbol)
    #t
    (string? (≈⊙parse "foo")))

; Test 8: Parse empty list
(test-case (quote :parse-empty-list)
    #t
    (null? (≈⊙parse "()")))

; Test 9: Parse single-element list
(test-case (quote :parse-single-list)
    #t
    (and-all (not (null? (≈⊙parse "(foo)")))
        (string? (car (≈⊙parse "(foo)")))))

; Test 10: Parse two-element list
(test-case (quote :parse-two-list)
    #t
    (and-all (not (null? (≈⊙parse "(foo bar)")))
        (not (null? (cdr (≈⊙parse "(foo bar)"))))))

; ───────────────────────────────────────────────────────────────
; Integration Tests
; ───────────────────────────────────────────────────────────────

; Test 11: Parse nested list
(test-case (quote :parse-nested)
    #t
    (not (null? (≈⊙parse "((foo))"))))

; Test 12: Parse arithmetic expression
(test-case (quote :parse-arithmetic)
    #t
    (not (null? (≈⊙parse "(+ 1 2)"))))

; Test 13: Error on unclosed list
(test-case (quote :error-unclosed)
    #t
    (error? (≈⊙parse "(foo")))

; Test 14: Error on unexpected rparen
(test-case (quote :error-extra-rparen)
    #t
    (error? (≈⊙parse ")")))

; Test 15: Parse string literal
(test-case (quote :parse-string)
    #t
    (string? (≈⊙parse "\"hello\"")))

; ═══════════════════════════════════════════════════════════════
; End of Tests
; ═══════════════════════════════════════════════════════════════

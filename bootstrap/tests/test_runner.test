; Test Runner - Execute Auto-Generated Tests
; Collects tests from all primitives and user functions, runs them, reports results

; ============ Helper Functions ============

; Flatten nested list into single list
(â‰” flatten (Î» (lst)
  (? (âˆ…? lst)
     âˆ…
     (? (âŸ¨âŸ©? (â— lst))
        (append (flatten (â— lst)) (flatten (â–· lst)))
        (âŸ¨âŸ© (â— lst) (flatten (â–· lst)))))))

; Append two lists
(â‰” append (Î» (l1 l2)
  (? (âˆ…? l1)
     l2
     (âŸ¨âŸ© (â— l1) (append (â–· l1) l2)))))

; Count elements in list
(â‰” length (Î» (lst)
  (? (âˆ…? lst)
     #0
     (âŠ• #1 (length (â–· lst))))))

; Execute a single test (test is: (âŠ¨ :name expected actual))
; Returns: âŸ¨:pass nameâŸ© or âŸ¨:fail name expected actualâŸ©
(â‰” execute-test (Î» (test)
  (? (âˆ…? test)
     âŸ¨:error :empty-testâŸ©
     ; Test structure: (âŠ¨ :name expected actual)
     (â‰” test-sym (â— test))              ; Should be âŠ¨
     (â‰” name (â— (â–· test)))              ; Get :name
     (â‰” expected (â— (â–· (â–· test))))      ; Get expected
     (â‰” actual (â— (â–· (â–· (â–· test)))))    ; Get actual

     ; Compare using deep equality
     (? (â‰Ÿ expected actual)
        âŸ¨:pass nameâŸ©
        âŸ¨:fail name expected actualâŸ©))))

; Execute all tests in list
(â‰” run-test-list (Î» (tests)
  (? (âˆ…? tests)
     âˆ…
     (âŸ¨âŸ© (execute-test (â— tests))
         (run-test-list (â–· tests))))))

; Count test results by status
(â‰” count-status (Î» (results status)
  (? (âˆ…? results)
     #0
     (? (â‰¡ (â— (â— results)) status)
        (âŠ• #1 (count-status (â–· results) status))
        (count-status (â–· results) status)))))

; Summarize test results
(â‰” summarize-results (Î» (results)
  (â‰” passed (count-status results :pass))
  (â‰” failed (count-status results :fail))
  (â‰” errors (count-status results :error))
  âŸ¨:passed passed :failed failed :errors errors :total (length results)âŸ©))

; ============ Primitive Test Collection ============

; Core arithmetic primitives
(â‰” arithmetic-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŠ•))
  (append (âŒ‚âŠ¨ (âŒœ âŠ–))
  (append (âŒ‚âŠ¨ (âŒœ âŠ—))
  (append (âŒ‚âŠ¨ (âŒœ âŠ˜))
  (append (âŒ‚âŠ¨ (âŒœ %))
  âˆ…)))))))

; Comparison primitives
(â‰” comparison-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ â‰¡))
  (append (âŒ‚âŠ¨ (âŒœ â‰¢))
  (append (âŒ‚âŠ¨ (âŒœ <))
  (append (âŒ‚âŠ¨ (âŒœ >))
  (append (âŒ‚âŠ¨ (âŒœ â‰¤))
  (append (âŒ‚âŠ¨ (âŒœ â‰¥))
  âˆ…))))))))

; Logic primitives
(â‰” logic-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âˆ§))
  (append (âŒ‚âŠ¨ (âŒœ âˆ¨))
  (append (âŒ‚âŠ¨ (âŒœ Â¬))
  âˆ…)))))

; Type predicates
(â‰” type-predicate-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ â„•?))
  (append (âŒ‚âŠ¨ (âŒœ ğ”¹?))
  (append (âŒ‚âŠ¨ (âŒœ :?))
  (append (âŒ‚âŠ¨ (âŒœ âˆ…?))
  (append (âŒ‚âŠ¨ (âŒœ âŸ¨âŸ©?))
  (append (âŒ‚âŠ¨ (âŒœ #?))
  âˆ…))))))))

; Core list operations
(â‰” list-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŸ¨âŸ©))
  (append (âŒ‚âŠ¨ (âŒœ â—))
  (append (âŒ‚âŠ¨ (âŒœ â–·))
  âˆ…)))))

; Metaprogramming
(â‰” meta-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŒœ))
  âˆ…)))

; Debug and error handling
(â‰” debug-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âš ))
  (append (âŒ‚âŠ¨ (âŒœ âš ?))
  (append (âŒ‚âŠ¨ (âŒœ âŠ¢))
  (append (âŒ‚âŠ¨ (âŒœ âŸ²))
  âˆ…))))))

; Self-introspection
(â‰” introspection-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ â§‰))
  (append (âŒ‚âŠ¨ (âŒœ âŠ›))
  âˆ…))))

; Testing primitives
(â‰” testing-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ â‰Ÿ))
  (append (âŒ‚âŠ¨ (âŒœ âŠ¨))
  âˆ…))))

; Documentation primitives
(â‰” doc-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚))
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚âˆˆ))
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚â‰”))
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚âŠ›))
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚âŠ¨))
  âˆ…)))))))

; CFG/DFG
(â‰” cfg-dfg-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚âŸ¿))
  (append (âŒ‚âŠ¨ (âŒœ âŒ‚â‡))
  âˆ…))))

; Structure - Leaf
(â‰” structure-leaf-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŠ™â‰”))
  (append (âŒ‚âŠ¨ (âŒœ âŠ™))
  (append (âŒ‚âŠ¨ (âŒœ âŠ™â†’))
  (append (âŒ‚âŠ¨ (âŒœ âŠ™â†))
  (append (âŒ‚âŠ¨ (âŒœ âŠ™?))
  âˆ…)))))))

; Structure - Node/ADT
(â‰” structure-node-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŠšâ‰”))
  (append (âŒ‚âŠ¨ (âŒœ âŠš))
  (append (âŒ‚âŠ¨ (âŒœ âŠšâ†’))
  (append (âŒ‚âŠ¨ (âŒœ âŠš?))
  âˆ…))))))

; Graph
(â‰” graph-tests (Î» ()
  (append (âŒ‚âŠ¨ (âŒœ âŠâ‰”))
  (append (âŒ‚âŠ¨ (âŒœ âŠ))
  (append (âŒ‚âŠ¨ (âŒœ âŠâŠ•))
  (append (âŒ‚âŠ¨ (âŒœ âŠâŠ—))
  (append (âŒ‚âŠ¨ (âŒœ âŠâ†’))
  (append (âŒ‚âŠ¨ (âŒœ âŠ?))
  âˆ…))))))))

; ============ Main Test Runner ============

; Collect all primitive tests
(â‰” all-primitive-tests (Î» ()
  (append (arithmetic-tests)
  (append (comparison-tests)
  (append (logic-tests)
  (append (type-predicate-tests)
  (append (list-tests)
  (append (meta-tests)
  (append (debug-tests)
  (append (introspection-tests)
  (append (testing-tests)
  (append (doc-tests)
  (append (cfg-dfg-tests)
  (append (structure-leaf-tests)
  (append (structure-node-tests)
  (append (graph-tests)
  âˆ…)))))))))))))))))

; Run all tests and report
(â‰” run-all-tests (Î» ()
  (â‰” tests (flatten (all-primitive-tests)))  ; Flatten nested lists
  (â‰” results (run-test-list tests))
  (â‰” summary (summarize-results results))
  âŸ¨:summary summary :results resultsâŸ©))

; ============ Coverage Reporting ============

; Generate coverage report by category
(â‰” coverage-by-category (Î» ()
  (âŸ¨âŸ© âŸ¨:category :arithmetic :count (length (flatten (arithmetic-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :comparison :count (length (flatten (comparison-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :logic :count (length (flatten (logic-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :type-predicates :count (length (flatten (type-predicate-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :lists :count (length (flatten (list-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :metaprogramming :count (length (flatten (meta-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :debug :count (length (flatten (debug-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :introspection :count (length (flatten (introspection-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :testing :count (length (flatten (testing-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :documentation :count (length (flatten (doc-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :cfg-dfg :count (length (flatten (cfg-dfg-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :structures-leaf :count (length (flatten (structure-leaf-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :structures-node :count (length (flatten (structure-node-tests)))âŸ©
  (âŸ¨âŸ© âŸ¨:category :graphs :count (length (flatten (graph-tests)))âŸ©
  âˆ…))))))))))))))

; ============ Execute Test Run ============

; Run the test suite
âŸ² :starting-test-run
(â‰” results (run-all-tests))
âŸ² :test-run-complete
(â‰” coverage (coverage-by-category))
âŸ² :coverage-report
âŸ¨:results results :coverage coverageâŸ©

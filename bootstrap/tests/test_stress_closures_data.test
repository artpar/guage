;;; Stress: Closures + Data Structures
;;; Tier 2 — Two-feature combination stress test

;;; --- 1. Build HashMap via closure inserter: closure called 10,000 times ---

(≔ hm1 (⊞))
(≔ inserter (λ (k v) (⊞← hm1 k v)))

(≔ insert-loop (λ (i)
  (? (≡ i #0) :done
     (⪢ (inserter i (⊗ i #3))
         (insert-loop (⊖ i #1))))))

(insert-loop #10000)

(⊨ :cd-hm-via-closure #10000 (⊞# hm1))
(⊨ :cd-hm-lookup #15000 (⊞→ hm1 #5000))

;;; --- 2. Vector of 5,000 closures capturing index, apply all ---

(≔ make-idx-fn (λ (idx) (λ () idx)))

(≔ fn-vec (⟦⟧))

(≔ build-fn-vec (λ (i)
  (? (≡ i #5000) :done
     (⪢ (⟦⊕ fn-vec (make-idx-fn i))
         (build-fn-vec (⊕ i #1))))))

(build-fn-vec #0)

(⊨ :cd-fn-vec-size #5000 (⟦# fn-vec))
(⊨ :cd-fn-vec-first #0 ((⟦→ fn-vec #0)))
(⊨ :cd-fn-vec-last #4999 ((⟦→ fn-vec #4999)))

;;; --- 3. fold over list with HashMap accumulator counting frequencies ---

(≔ freq (⊞))

(≔ freq-fold (λ (lst)
  (? (∅? lst) freq
     (⪢
       (≔ k (⊛% (◁ lst) #10))
       (≔ cur (⊞→ freq k))
       (⊞← freq k (? (∅? cur) #1 (⊕ cur #1)))
       (freq-fold (▷ lst))))))

;; Build list of 50,000 numbers
(≔ build-numlist (λ (n acc)
  (? (≡ n #0) acc
     (build-numlist (⊖ n #1) (⟨⟩ n acc)))))

(≔ numlist (build-numlist #50000 ∅))
(freq-fold numlist)

;; 10 frequency buckets (0..9), each ~5000
(⊨ :cd-freq-buckets #10 (⊞# freq))

;;; --- 4. Deque as work queue: enqueue 10,000 closures, dequeue and execute ---

(≔ work-dq (⊟))

(≔ enqueue-work (λ (i)
  (? (≡ i #0) :done
     (⪢ (⊟▷ work-dq (make-const i))
         (enqueue-work (⊖ i #1))))))

(≔ make-const (λ (n) (λ () n)))

(enqueue-work #10000)

(⊨ :cd-dq-size #10000 (⊟# work-dq))

;; Execute all and sum
(≔ exec-dq (λ (acc)
  (? (≡ (⊟# work-dq) #0) acc
     (⪢ (≔ fn (⊟⊖◁ work-dq))
         (exec-dq (⊕ acc (fn)))))))

(⊨ :cd-dq-exec-sum #50005000 (exec-dq #0))

;;; --- 5. Closure captures Vector ref, pushes 50,000 elements ---

(≔ cv (⟦⟧))
(≔ push-to-vec (λ (val) (⟦⊕ cv val)))

(≔ push-loop (λ (i)
  (? (≡ i #50000) :done
     (⪢ (push-to-vec i)
         (push-loop (⊕ i #1))))))

(push-loop #0)

(⊨ :cd-closure-vec-50k #50000 (⟦# cv))

;;; --- 6. SortedMap built by closure applications in pipeline ---

(≔ sm1 (⋔))
(≔ sm-insert (λ (k v) (⋔← sm1 k v)))

(≔ sm-build (λ (i)
  (? (≡ i #0) :done
     (⪢ (sm-insert (⊖ #10001 i) i)
         (sm-build (⊖ i #1))))))

(sm-build #10000)

(⊨ :cd-sm-size #10000 (⋔# sm1))
(⊨ :cd-sm-min-val #10000 (⋔→ sm1 #1))

;;; --- 7. Trie built from closures each returning a key ---

(≔ tr1 (⊮))

(≔ make-key-fn (λ (i) (λ () (⊕≋ "k" (→≋ i)))))

(≔ trie-build (λ (i)
  (? (≡ i #0) :done
     (⪢
       (≔ kfn (make-key-fn i))
       (⊮← tr1 (kfn) i)
       (trie-build (⊖ i #1))))))

(trie-build #3000)

(⊨ :cd-trie-size #3000 (⊮# tr1))
(⊨ :cd-trie-lookup #1 (⊮→ tr1 "k1"))

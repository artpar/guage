;;; Stress: Full-Stack GenServer
;;; Tier 3 — GenServer + Patterns + ETS + Supervisor + Effects

(⟳∅)
(⟿∅)

;;; --- Effect declarations ---

(⟪ :Compute :calc)

;;; --- 1. GenServer handles 10,000 calls dispatched via pattern match ---

(⟳∅)

(≔ dispatch-server (⟳ (λ (self)
  (≔ srv-loop (λ ()
    (≫ (←?) (λ (msg)
      (⪢
        ;; msg = ⟨:call caller-id request⟩
        (≔ caller (◁ (▷ msg)))
        (≔ req (◁ (▷ (▷ msg))))
        (≔ response
          (? (≡ (⊛% req #5) #0) (⊗ req #2)
             (? (≡ (⊛% req #5) #1) (⊕ req #10)
                (? (≡ (⊛% req #5) #2) (⊖ req #1)
                   (? (≡ (⊛% req #5) #3) (⊗ req req)
                      req)))))
        (≫ (⟳⇅! caller response) (λ (_)
          (srv-loop))))))))
  (srv-loop))))

;; Client makes 10,000 calls
(≔ client-10k (⟳ (λ (self)
  (≔ cl-loop (λ (n total)
    (? (≡ n #0) total
       (≫ (⟳⇅ dispatch-server n) (λ (r)
         (cl-loop (⊖ n #1) (⊕ total #1)))))))
  (cl-loop #10000 #0))))

(⟳! #500000)
(⊨ :fs-dispatch-10k #10000 (⟳→ client-10k))

;;; --- 2. GenServer + ETS: crash/restart cycles, ETS preserved ---

(⟳∅)

(⟳⊞⊕ :server-data)
(⟳⊞⊙ :server-data :calls #0)

(≔ ets-server-fn (λ (self)
  (⪢
    (≔ cur (⟳⊞? :server-data :calls))
    (⟳⊞⊙ :server-data :calls (⊕ cur #1))
    (≫ (←?) (λ (msg)
      (⪢
        (≔ caller (◁ (▷ msg)))
        (≔ req (◁ (▷ (▷ msg))))
        (⟳⊞⊙ :server-data :calls (⊕ (⟳⊞? :server-data :calls) #1))
        (? (≡ req :crash)
           (⚠ :server-crash ∅)
           (⟳⇅! caller (⟳⊞? :server-data :calls)))))))))

(≔ ets-sup (⟳⊛ :one-for-one (⟨⟩ ets-server-fn ∅)))
(⟳! #500)

;; Crash and restart 10 times
(≔ crash-server (λ (n)
  (? (≡ n #0) :done
     (⪢
       (≔ kids (⟳⊛? ets-sup))
       (≔ srv (◁ kids))
       (→! srv (⟨⟩ :call srv :crash))
       (⟳! #2000)
       (crash-server (⊖ n #1))))))

(crash-server #10)

;; ETS counter should be > 10 (initial starts + restarts)
(⊨ :fs-ets-survives #t (> (⟳⊞? :server-data :calls) #10))

;;; --- 3. Pipeline of 3 GenServers ---

(⟳∅)

(≔ make-pipe-server (λ (transform-fn)
  (⟳ (λ (self)
    (≔ ps-loop (λ ()
      (≫ (←?) (λ (msg)
        (⪢
          (≔ caller (◁ (▷ msg)))
          (≔ req (◁ (▷ (▷ msg))))
          (≫ (⟳⇅! caller (transform-fn req)) (λ (_)
            (ps-loop))))))))
    (ps-loop)))))

(≔ validate-srv (make-pipe-server (λ (x) (? (> x #0) x (⚠ :invalid x)))))
(≔ process-srv (make-pipe-server (λ (x) (⊗ x #2))))
(≔ respond-srv (make-pipe-server (λ (x) (⊕ x #100))))

(≔ pipeline-client (⟳ (λ (self)
  (≔ pipe-loop (λ (n total)
    (? (≡ n #0) total
       (≫ (⟳⇅ validate-srv n) (λ (v)
         (? (⚠? v) (pipe-loop (⊖ n #1) total)
            (≫ (⟳⇅ process-srv v) (λ (p)
              (≫ (⟳⇅ respond-srv p) (λ (r)
                (pipe-loop (⊖ n #1) (⊕ total #1)))))))))))
  (pipe-loop #5000 #0))))

(⟳! #500000)
(⊨ :fs-pipeline-5k #5000 (⟳→ pipeline-client))

;;; --- 4. Supervised farm: 5 GenServers + supervisor, round-robin ---

(⟳∅)

(≔ make-farm-worker (λ ()
  (λ (self)
    (≔ fw-loop (λ ()
      (≫ (←?) (λ (msg)
        (⪢
          (≔ caller (◁ (▷ msg)))
          (≔ req (◁ (▷ (▷ msg))))
          (≫ (⟳⇅! caller (⊗ req #3)) (λ (_)
            (fw-loop))))))))
    (fw-loop))))

(≔ farm-children (λ (n acc)
  (? (≡ n #0) acc
     (farm-children (⊖ n #1) (⟨⟩ (make-farm-worker) acc)))))

(≔ farm-sup (⟳⊛ :one-for-one (farm-children #5 ∅)))
(⟳! #500)

(≔ farm-kids (⟳⊛? farm-sup))

;; Round-robin client across 5 workers
(≔ farm-client (⟳ (λ (self)
  (≔ rr-loop (λ (n total workers)
    (? (≡ n #0) total
       (⪢
         (≔ w (? (∅? workers) farm-kids workers))
         (≫ (⟳⇅ (◁ w) n) (λ (r)
           (rr-loop (⊖ n #1) (⊕ total #1) (▷ w))))))))
  (rr-loop #10000 #0 farm-kids))))

(⟳! #500000)
(⊨ :fs-farm-10k #10000 (⟳→ farm-client))

;;; --- 5. GenServer uses effect handler for computation ---

(⟳∅)

(≔ effect-server (⟳ (λ (self)
  (≔ es-loop (λ ()
    (≫ (←?) (λ (msg)
      (⪢
        (≔ caller (◁ (▷ msg)))
        (≔ req (◁ (▷ (▷ msg))))
        (≔ result (⟪⟫ (↯ :Compute :calc req)
                     (:Compute (:calc (λ (x) (⊕ x #42))))))
        (≫ (⟳⇅! caller result) (λ (_)
          (es-loop))))))))
  (es-loop))))

(≔ eff-client (⟳ (λ (self)
  (≔ ec-loop (λ (n total)
    (? (≡ n #0) total
       (≫ (⟳⇅ effect-server n) (λ (r)
         (ec-loop (⊖ n #1) (⊕ total r)))))))
  (ec-loop #5000 #0))))

(⟳! #500000)

;; Each call returns n+42, sum of (n+42) for n=1..5000
(≔ eff-client-result (⟳→ eff-client))
(⊨ :fs-effect-server #t (> eff-client-result #0))

#!/usr/bin/env guage
; Test suite for module system improvements
; Caching, circular detection, ⋘?, ⊞◇, module-import-validated

(print "Testing Module System...")

; --- module-loaded? module-loaded predicate ---

; A module we haven't loaded should not be loaded
(test-case :module-loaded-false
   #f
   (module-loaded? "nonexistent_module.scm"))

; Load a known stdlib module and check it's cached
(load "bootstrap/stdlib/math.scm")
(test-case :module-loaded-after-load
   #t
   (module-loaded? "bootstrap/stdlib/math.scm"))

; --- Caching: loading twice returns cached result ---

; Create a side-effect counter via box
(define load-counter (box #0))

; Load math again - should be cached, no re-evaluation
(load "bootstrap/stdlib/math.scm")
(test-case :cached-load-no-reeval
   #t
   (module-loaded? "bootstrap/stdlib/math.scm"))

; --- module-define module-define (exports + version) ---

; Check that the module-define primitive exists (not an error when referenced)
(test-case :module-define-exists
   #t
   (not (error? module-define)))

; --- module-import-validated validated import ---

; Import a loaded module without symbol filtering
(test-case :validated-import-basic
   #t
   (not (error? (module-import-validated "bootstrap/stdlib/math.scm"))))

; --- Error on non-existent module ---
(test-case :validated-import-missing
   #t
   (error? (module-import-validated "nonexistent_file_xyz.scm")))

(print "\nModule system tests complete.")

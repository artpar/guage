; Day 140: Supervisor exit fix — proper stripe lock + g_alive_actors + actor_notify_exit
; Tests one-for-all and rest-for-one kill paths

(actor-reset)

; ── Test 1: One-for-all — all children restarted, g_alive_actors correct ──

(define worker (lambda (self) (actor-receive)))  ; Block waiting for a message

(define crasher (lambda (self)
  (bind (actor-receive) (lambda (msg)
    (if (equal? msg :crash)
       (error :crashed :boom)
       msg)))))

(define sup1 (sup-start :one-for-all (cons crasher (cons worker (cons worker nil)))))
(actor-run #200)

; Get children before crash
(define kids1 (sup-children sup1))
(define c1 (car kids1))
(define c2 (car (cdr kids1)))
(define c3 (car (cdr (cdr kids1))))

; All 3 should be alive
(test-case (quote :ofa-3-children-alive)
  #t
  (and (actor-alive? c1) (and (actor-alive? c2) (actor-alive? c3))))

; Crash the first child
(actor-send c1 :crash)
(actor-run #400)

; After restart, new children should be alive
(define kids1b (sup-children sup1))
(define n1 (car kids1b))
(define n2 (car (cdr kids1b)))
(define n3 (car (cdr (cdr kids1b))))

(test-case (quote :ofa-new-children-alive)
  #t
  (and (actor-alive? n1) (and (actor-alive? n2) (actor-alive? n3))))

; Original non-crashed children should be dead (replaced)
(test-case (quote :ofa-old-c2-dead) #f (actor-alive? c2))
(test-case (quote :ofa-old-c3-dead) #f (actor-alive? c3))


; ── Test 2: Rest-for-one — only later children killed/restarted ──

(actor-reset)

(define stable (lambda (self) (actor-receive)))

(define crasher2 (lambda (self)
  (bind (actor-receive) (lambda (msg)
    (if (equal? msg :crash)
       (error :crashed :boom)
       msg)))))

; 3 children: stable, crasher, stable
(define sup2 (sup-start :rest-for-one (cons stable (cons crasher2 (cons stable nil)))))
(actor-run #200)

(define kids2 (sup-children sup2))
(define s1 (car kids2))
(define cr (car (cdr kids2)))
(define s2 (car (cdr (cdr kids2))))

; Crash middle child
(actor-send cr :crash)
(actor-run #400)

(define kids2b (sup-children sup2))
(define s1b (car kids2b))
(define crb (car (cdr kids2b)))
(define s2b (car (cdr (cdr kids2b))))

; First child (before crasher) should be unchanged
(test-case (quote :rfo-first-unchanged) #t (equal? s1 s1b))

; Old third child should be dead (it was after the crashed one)
(test-case (quote :rfo-old-third-dead) #f (actor-alive? s2))

; New third child should be alive
(test-case (quote :rfo-new-third-alive) #t (actor-alive? s2b))


; ── Test 3: One-for-one does NOT kill siblings ──

(actor-reset)

(define crasher3 (lambda (self)
  (bind (actor-receive) (lambda (msg)
    (if (equal? msg :crash)
       (error :crashed :boom)
       msg)))))

(define worker3 (lambda (self) (actor-receive)))

(define sup3 (sup-start :one-for-one (cons crasher3 (cons worker3 nil))))
(actor-run #200)

(define kids3 (sup-children sup3))
(define cr3 (car kids3))
(define w3 (car (cdr kids3)))

; Crash the first child
(actor-send cr3 :crash)
(actor-run #400)

; Second child should be unchanged (one-for-one doesn't touch it)
(define kids3b (sup-children sup3))
(define w3b (car (cdr kids3b)))
(test-case (quote :ofo-sibling-unchanged) #t (equal? w3 w3b))
(test-case (quote :ofo-sibling-alive) #t (actor-alive? w3b))

;;; Stress: Algebraic Effects
;;; Tier 1 — Perform, handle, resume, nested handlers, linear effects

;;; --- Effect declarations ---

(⟪ :Counter :inc :get)
(⟪ :Yield :value)
(⟪ :State :get :put)
(⟪ :Logger :log)
(⟪ :Transform :apply)
(⟪ :Validate :check)
(⟪ :Cache :fetch)
(⟪ :Auth :verify)

;;; --- 1. 10,000 sequential perform calls in resumable handler ---

(≔ count-loop (λ (n)
  (? (≡ n #0) :done
     (⪢ (↯ :Counter :inc) (count-loop (⊖ n #1))))))

(≔ counted
  (⟪↺⟫ (count-loop #10000)
    (:Counter
      (:inc (λ (k) (k ∅)))
      (:get (λ (k) (k #0))))))

(⊨ :effect-10k-performs :done counted)

;;; --- 2. 8-deep nested effect handlers ---

(⊨ :effect-8-nested #42
  (⟪⟫
    (⟪⟫
      (⟪⟫
        (⟪⟫
          (⟪⟫
            (⟪⟫
              (⟪⟫
                (⟪⟫ (↯ :Validate :check #42)
                  (:Validate (:check (λ (x) x))))
                (:Transform (:apply (λ (x) x))))
              (:Cache (:fetch (λ (k) k))))
            (:Auth (:verify (λ (t) t))))
          (:Logger (:log (λ (msg) msg))))
        (:State (:get (λ () #0)) (:put (λ (v) ∅))))
      (:Counter (:inc (λ () ∅)) (:get (λ () #0))))
    (:Yield (:value (λ (v) v)))))

;;; --- 3. Effect forwarding: nested resumable, small count ---

(≔ forward-loop (λ (n acc)
  (? (≡ n #0) acc
     (forward-loop (⊖ n #1) (⊕ acc (↯ :Counter :inc))))))

(⊨ :effect-forward-10 #10
  (⟪↺⟫
    (⟪↺⟫ (forward-loop #10 #0)
      (:Counter
        (:inc (λ (k) (k #1)))
        (:get (λ (k) (k #0)))))
    (:Logger (:log (λ (msg) msg)))))

;;; --- 4. Resumable continuation with value ---

(≔ resume-test
  (⟪↺⟫ (⊕ (↯ :State :get) #100)
    (:State
      (:get (λ (k) (k #42)))
      (:put (λ (k v) (k ∅))))))

(⊨ :effect-resume-val #142 resume-test)

;;; --- 5. Accumulate via resumable handler 1000 times ---

(≔ resume-loop (λ (n acc)
  (? (≡ n #0) acc
     (resume-loop (⊖ n #1) (⊕ acc (↯ :State :get))))))

(≔ resume-sum
  (⟪↺⟫ (resume-loop #1000 #0)
    (:State
      (:get (λ (k) (k #1)))
      (:put (λ (k v) (k ∅))))))

(⊨ :effect-resume-1k #1000 resume-sum)

;;; --- 6. Linear effect consumed once, verified 5,000 times in loop ---

(⟪ :Linear :consume)

(≔ linear-loop (λ (n acc)
  (? (≡ n #0) acc
     (linear-loop (⊖ n #1)
       (⊕ acc (⟪⟫ (↯ :Linear :consume #1)
                 (:Linear (:consume (λ (x) x)))))))))

(⊨ :effect-linear-5k #5000 (linear-loop #5000 #0))

;;; --- 7. Recursive function performing effect at each level ---

(≔ recursive-effect (λ (n)
  (? (≡ n #0) #0
     (⊕ (↯ :Counter :inc) (recursive-effect (⊖ n #1))))))

(≔ rec-eff-result
  (⟪↺⟫ (recursive-effect #250)
    (:Counter
      (:inc (λ (k) (k #1)))
      (:get (λ (k) (k #0))))))

(⊨ :effect-recursive-250 #250 rec-eff-result)

;;; --- 8. Non-resumable handler dispatching multiple ops ---

(⊨ :effect-dispatch-inc #1
  (⟪⟫ (↯ :Counter :inc)
    (:Counter
      (:inc (λ () #1))
      (:get (λ () #0)))))

(⊨ :effect-dispatch-get #0
  (⟪⟫ (↯ :Counter :get)
    (:Counter
      (:inc (λ () #1))
      (:get (λ () #0)))))

(⊨ :effect-dispatch-check #99
  (⟪⟫ (↯ :Validate :check #99)
    (:Validate (:check (λ (x) x)))))

(⊨ :effect-dispatch-log :hello
  (⟪⟫ (↯ :Logger :log :hello)
    (:Logger (:log (λ (msg) msg)))))

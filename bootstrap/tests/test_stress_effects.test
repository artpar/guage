;;; Stress: Algebraic Effects
;;; Tier 1 â€” Perform, handle, resume, nested handlers, linear effects

;;; --- Effect declarations ---

(effect-def :Counter :inc :get)
(effect-def :Yield :value)
(effect-def :State :get :put)
(effect-def :Logger :log)
(effect-def :Transform :apply)
(effect-def :Validate :check)
(effect-def :Cache :fetch)
(effect-def :Auth :verify)

;;; --- 1. 10,000 sequential perform calls in resumable handler ---

(define count-loop (lambda (n)
  (if (equal? n #0) :done
     (begin (perform :Counter :inc) (count-loop (- n #1))))))

(define counted
  (handle-resume (count-loop #10000)
    (:Counter
      (:inc (lambda (k) (k nil)))
      (:get (lambda (k) (k #0))))))

(test-case :effect-10k-performs :done counted)

;;; --- 2. 8-deep nested effect handlers ---

(test-case :effect-8-nested #42
  (handle
    (handle
      (handle
        (handle
          (handle
            (handle
              (handle
                (handle (perform :Validate :check #42)
                  (:Validate (:check (lambda (x) x))))
                (:Transform (:apply (lambda (x) x))))
              (:Cache (:fetch (lambda (k) k))))
            (:Auth (:verify (lambda (t) t))))
          (:Logger (:log (lambda (msg) msg))))
        (:State (:get (lambda () #0)) (:put (lambda (v) nil))))
      (:Counter (:inc (lambda () nil)) (:get (lambda () #0))))
    (:Yield (:value (lambda (v) v)))))

;;; --- 3. Effect forwarding: nested resumable, small count ---

(define forward-loop (lambda (n acc)
  (if (equal? n #0) acc
     (forward-loop (- n #1) (+ acc (perform :Counter :inc))))))

(test-case :effect-forward-10 #10
  (handle-resume
    (handle-resume (forward-loop #10 #0)
      (:Counter
        (:inc (lambda (k) (k #1)))
        (:get (lambda (k) (k #0)))))
    (:Logger (:log (lambda (msg) msg)))))

;;; --- 4. Resumable continuation with value ---

(define resume-test
  (handle-resume (+ (perform :State :get) #100)
    (:State
      (:get (lambda (k) (k #42)))
      (:put (lambda (k v) (k nil))))))

(test-case :effect-resume-val #142 resume-test)

;;; --- 5. Accumulate via resumable handler 1000 times ---

(define resume-loop (lambda (n acc)
  (if (equal? n #0) acc
     (resume-loop (- n #1) (+ acc (perform :State :get))))))

(define resume-sum
  (handle-resume (resume-loop #1000 #0)
    (:State
      (:get (lambda (k) (k #1)))
      (:put (lambda (k v) (k nil))))))

(test-case :effect-resume-1k #1000 resume-sum)

;;; --- 6. Linear effect consumed once, verified 5,000 times in loop ---

(effect-def :Linear :consume)

(define linear-loop (lambda (n acc)
  (if (equal? n #0) acc
     (linear-loop (- n #1)
       (+ acc (handle (perform :Linear :consume #1)
                 (:Linear (:consume (lambda (x) x)))))))))

(test-case :effect-linear-5k #5000 (linear-loop #5000 #0))

;;; --- 7. Recursive function performing effect at each level ---

(define recursive-effect (lambda (n)
  (if (equal? n #0) #0
     (+ (perform :Counter :inc) (recursive-effect (- n #1))))))

(define rec-eff-result
  (handle-resume (recursive-effect #250)
    (:Counter
      (:inc (lambda (k) (k #1)))
      (:get (lambda (k) (k #0))))))

(test-case :effect-recursive-250 #250 rec-eff-result)

;;; --- 8. Non-resumable handler dispatching multiple ops ---

(test-case :effect-dispatch-inc #1
  (handle (perform :Counter :inc)
    (:Counter
      (:inc (lambda () #1))
      (:get (lambda () #0)))))

(test-case :effect-dispatch-get #0
  (handle (perform :Counter :get)
    (:Counter
      (:inc (lambda () #1))
      (:get (lambda () #0)))))

(test-case :effect-dispatch-check #99
  (handle (perform :Validate :check #99)
    (:Validate (:check (lambda (x) x)))))

(test-case :effect-dispatch-log :hello
  (handle (perform :Logger :log :hello)
    (:Logger (:log (lambda (msg) msg)))))

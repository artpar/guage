;;; Stress: Channels
;;; Tier 1 — Create, send, recv, close, FIFO, select, pipeline

(⟳∅)
(⟿∅)

;;; --- 1. Create 100 channels, send 1 msg on each, recv from each ---

(≔ create-channels (λ (n acc)
  (? (≡ n #0) acc
     (create-channels (⊖ n #1) (⟨⟩ (⟿⊚) acc)))))

(≔ channels-100 (create-channels #100 ∅))

;; Send to each channel synchronously (no actors needed for send)
(≔ send-each (λ (chs i)
  (? (∅? chs) :done
     (⪢ (⟿→ (◁ chs) i)
         (send-each (▷ chs) (⊕ i #1))))))

(send-each channels-100 #1)

;; Recv from each synchronously
(≔ recv-each (λ (chs acc)
  (? (∅? chs) acc
     (recv-each (▷ chs) (⊕ acc (⟿← (◁ chs)))))))

(≔ recv-sum (recv-each channels-100 #0))

;; Sum of 1..100 = 5050
(⊨ :chan-100-send-recv #5050 recv-sum)

;;; --- 2. Single channel: send 64 items (max capacity), recv all, verify FIFO ---

(⟿∅)

(≔ ch64 (⟿⊚))

;; Fill synchronously
(≔ fill-ch (λ (i)
  (? (≡ i #65) :filled
     (⪢ (⟿→ ch64 i) (fill-ch (⊕ i #1))))))

(fill-ch #1)

;; Drain and get first value
(≔ drain-first (λ (n first)
  (? (≡ n #0) first
     (drain-first (⊖ n #1)
       (? (≡ first ∅) (⟿← ch64) first)))))

(⊨ :chan-64-fifo-first #1 (drain-first #64 ∅))

;;; --- 3. Channel send/recv loop: 1000 send/recv pairs ---

(⟿∅)

(≔ ch-loop (⟿⊚))

(≔ sr-loop (λ (n total)
  (? (≡ n #0) total
     (⪢ (⟿→ ch-loop #1)
         (sr-loop (⊖ n #1) (⊕ total (⟿← ch-loop)))))))

(⊨ :chan-1k-send-recv #1000 (sr-loop #1000 #0))

;;; --- 4. Fan-in: 20 actors all send to 1 channel ---

(⟳∅)
(⟿∅)

(≔ fanin-ch (⟿⊚))

(≔ spawn-senders (λ (n)
  (? (≡ n #0) :done
     (⪢ (⟳ (λ (self) (⟿→ fanin-ch n)))
         (spawn-senders (⊖ n #1))))))

(spawn-senders #20)

;; Collector actor
(≔ col-loop (λ (n total)
  (? (≡ n #0) total
     (≫ (⟿← fanin-ch) (λ (v)
       (col-loop (⊖ n #1) (⊕ total v)))))))

(≔ collector (⟳ (λ (self) (col-loop #20 #0))))

(⟳! #20000)

;; Sum of 1..20 = 210
(⊨ :chan-fanin-20 #210 (⟳→ collector))

;;; --- 5. Channel capacity stress: single fill+drain of 50 items ---

(⟿∅)

(≔ cap-ch (⟿⊚))

(≔ fill-cap (λ (i)
  (? (≡ i #0) :ok
     (⪢ (⟿→ cap-ch i) (fill-cap (⊖ i #1))))))

(≔ drain-cap (λ (i sum)
  (? (≡ i #0) sum
     (drain-cap (⊖ i #1) (⊕ sum (⟿← cap-ch))))))

(fill-cap #50)

;; Sum 1..50 = 1275
(⊨ :chan-fill-drain-50 #1275 (drain-cap #50 #0))

;;; --- 6. Simple pipeline: 2 channels, transform through stage ---

(⟳∅)
(⟿∅)

(≔ pipe-in (⟿⊚))
(≔ pipe-out (⟿⊚))

;; Stage actor reads from pipe-in, adds 10, writes to pipe-out
(≔ stage-loop (λ (n)
  (? (≡ n #0) :done
     (≫ (⟿← pipe-in) (λ (v)
       (≫ (⟿→ pipe-out (⊕ v #10)) (λ (_)
         (stage-loop (⊖ n #1)))))))))

(≔ stage (⟳ (λ (self) (stage-loop #100))))

;; Send 100 values
(≔ send-pipe (λ (i)
  (? (≡ i #0) :done
     (⪢ (⟿→ pipe-in i) (send-pipe (⊖ i #1))))))

(send-pipe #100)
(⟳! #50000)

;; Read first result from pipe-out
(≔ pipe-result (⟿← pipe-out))

;; First sent value is 100, should become 110
(⊨ :chan-pipeline-first #110 pipe-result)

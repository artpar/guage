; ═══════════════════════════════════════════════════════════════
; Extended Trait Protocol Tests (Day 143)
; Mappable, Foldable, Semigroup, Monoid, Filterable, Hashable
; ═══════════════════════════════════════════════════════════════

(load "bootstrap/stdlib/list.scm")
(load "bootstrap/stdlib/sort.scm")
(load "bootstrap/stdlib/traits.scm")

(print "Testing Extended Trait Protocols...")

; Helper: list equality
(define list= (lambda (a) (lambda (b)
  (if (null? a) (null? b)
     (if (null? b) #f
        (if (equal? (car a) (car b))
           ((list= (cdr a)) (cdr b))
           #f))))))

; Helper
(define double (lambda (x) (* x #2)))
(define even? (lambda (x) (equal? (% x #2) #0)))

; ────────────────────────────────────────────────────────────────
; :Mappable
; ────────────────────────────────────────────────────────────────

(test-case :map-list
   #t
   ((list= ((⊧↦ double) (cons #1 (cons #2 (cons #3 nil)))))
           (cons #2 (cons #4 (cons #6 nil)))))

(test-case :map-nil  #t  (null? ((⊧↦ double) nil)))

; ────────────────────────────────────────────────────────────────
; :Foldable
; ────────────────────────────────────────────────────────────────

(test-case :fold-left-sum
   #6
   (((⊧⊕← (lambda (acc) (lambda (x) (+ acc x)))) #0) (cons #1 (cons #2 (cons #3 nil)))))

(test-case :fold-left-nil
   #0
   (((⊧⊕← (lambda (acc) (lambda (x) (+ acc x)))) #0) nil))

(test-case :fold-right-cons
   #t
   ((list= (((⊧⊕→ (lambda (x) (lambda (acc) (cons x acc)))) (cons #1 (cons #2 (cons #3 nil)))) nil))
           (cons #1 (cons #2 (cons #3 nil)))))

; ────────────────────────────────────────────────────────────────
; :Semigroup
; ────────────────────────────────────────────────────────────────

(test-case :combine-numbers  #7     ((⊧⊕⊕ #3) #4))
(test-case :combine-strings  "abcd" ((⊧⊕⊕ "ab") "cd"))
(test-case :combine-lists
   #t
   ((list= ((⊧⊕⊕ (cons #1 (cons #2 nil))) (cons #3 (cons #4 nil))))
           (cons #1 (cons #2 (cons #3 (cons #4 nil))))))

; ────────────────────────────────────────────────────────────────
; :Monoid
; ────────────────────────────────────────────────────────────────

(test-case :empty-number  #0  (⊧∅ #42))
(test-case :empty-string  ""  (⊧∅ "hello"))

(test-case :mconcat-numbers  #6  (⊧mconcat (cons #1 (cons #2 (cons #3 nil)))))

; ────────────────────────────────────────────────────────────────
; :Filterable
; ────────────────────────────────────────────────────────────────

(test-case :filter-evens
   #t
   ((list= ((⊧⊲ even?) (cons #1 (cons #2 (cons #3 (cons #4 nil))))))
           (cons #2 (cons #4 nil))))

(test-case :filter-nil  #t  (null? ((⊧⊲ even?) nil)))

; ────────────────────────────────────────────────────────────────
; :Hashable
; ────────────────────────────────────────────────────────────────

(test-case :hash-number  #42  ((trait-dispatch-fast #42 :Hashable :hash) #42))

(define str-hash ((trait-dispatch-fast "hello" :Hashable :hash) "hello"))
(test-case :hash-string-is-number  #t  (equal? (runtime-type-of str-hash) :Number))

(define sym-hash ((trait-dispatch-fast :foo :Hashable :hash) :foo))
(test-case :hash-symbol-is-number  #t  (equal? (runtime-type-of sym-hash) :Number))

; ────────────────────────────────────────────────────────────────
; Trait checks (trait?)
; ────────────────────────────────────────────────────────────────

(test-case :check-mappable-pair    #t  (trait? :Pair :Mappable))
(test-case :check-mappable-nil     #t  (trait? :Nil :Mappable))
(test-case :check-foldable-pair    #t  (trait? :Pair :Foldable))
(test-case :check-foldable-number  #f  (trait? :Number :Foldable))
(test-case :check-semigroup-num    #t  (trait? :Number :Semigroup))
(test-case :check-monoid-string    #t  (trait? :String :Monoid))
(test-case :check-hashable-number  #t  (trait? :Number :Hashable))

(print "\nExtended trait protocol tests complete.")

; Test: Weak References (weak-ref)
; Day 108 - Intrusive dual-count zombie weak references

; ============ Type Predicate Positive ============

(define t1 (box #42))
(define w1 (weak-ref t1))
(test-case (quote :weak-is-weak) #t (weak-ref? w1))

; ============ Type Predicate Negative ============

(test-case (quote :weak-not-weak) #f (weak-ref? #7))

; ============ Deref Returns Target When Alive ============

(test-case (quote :weak-deref-alive) #t (box? (weak-deref w1)))

; ============ Alive Check Returns True ============

(test-case (quote :weak-alive-true) #t (weak-alive? w1))

; ============ Deref Through Box ============

(test-case (quote :weak-deref-value) #42 (unbox (weak-deref w1)))

; ============ Weak Ref to Pair ============

(define t2 (cons #1 #2))
(define w2 (weak-ref t2))
(test-case (quote :weak-ref-pair) #1 (car (weak-deref w2)))

; ============ Weak Ref to Number ============

(define t3 #99)
(define w3 (weak-ref t3))
(test-case (quote :weak-ref-number) #99 (weak-deref w3))

; ============ Weak Ref to Nil ============

(define w4 (weak-ref nil))
(test-case (quote :weak-ref-nil) #t (weak-ref? w4))

; ============ Error: Deref Non-Weak ============

(test-case (quote :weak-deref-error) #t (error? (weak-deref #5)))

; ============ Error: Alive Check on Non-Weak ============

(test-case (quote :weak-alive-error) #t (error? (weak-alive? #5)))

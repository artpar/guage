; Day 99: ETS (Erlang Term Storage) â€” shared named tables
; Primitives: ets-new (new), ets-insert (insert), ets-lookup (lookup), ets-delete-key (delete),
;             ets-delete-table (delete-table), ets-size (size), ets-all (all)
(actor-reset)

; === ets-new-basic ===
; Create a named ETS table
(actor-reset)
(test-case (quote :ets-new-basic) :users (ets-new :users))

; === ets-insert-lookup ===
; Insert and lookup a key
(actor-reset)
(ets-new :cache)
(ets-insert :cache :key1 #42)
(test-case (quote :ets-insert-lookup) #42 (ets-lookup :cache :key1))

; === ets-lookup-missing ===
; Lookup missing key returns nil
(actor-reset)
(ets-new :data)
(test-case (quote :ets-lookup-missing) nil (ets-lookup :data :nope))

; === ets-insert-overwrite ===
; Insert same key overwrites
(actor-reset)
(ets-new :cfg)
(ets-insert :cfg :port #8080)
(ets-insert :cfg :port #9090)
(test-case (quote :ets-insert-overwrite) #9090 (ets-lookup :cfg :port))

; === ets-delete-key ===
; Delete a key from table
(actor-reset)
(ets-new :store)
(ets-insert :store :x #1)
(ets-insert :store :y #2)
(ets-delete-key :store :x)
(test-case (quote :ets-delete-key) nil (ets-lookup :store :x))

; === ets-size ===
; Table size tracking
(actor-reset)
(ets-new :items)
(ets-insert :items :a #1)
(ets-insert :items :b #2)
(ets-insert :items :c #3)
(test-case (quote :ets-size) #3 (ets-size :items))

; === ets-all-entries ===
; Get all entries as list of pairs
(actor-reset)
(ets-new :pairs)
(ets-insert :pairs :x #10)
(ets-insert :pairs :y #20)
(define all (ets-all :pairs))
(test-case (quote :ets-all-entries) #2 (ets-size :pairs))

; === ets-delete-table ===
; Delete entire table
(actor-reset)
(ets-new :temp)
(ets-insert :temp :k #1)
(ets-delete-table :temp)
(test-case (quote :ets-delete-table) #t (error? (ets-lookup :temp :k)))

; === ets-duplicate-name ===
; Creating table with same name is error
(actor-reset)
(ets-new :uniq)
(test-case (quote :ets-duplicate-name) #t (error? (ets-new :uniq)))

; === ets-cross-actor ===
; Multiple actors can read/write same table
(actor-reset)
(ets-new :shared)
(define writer (actor-spawn (lambda (self)
  (ets-insert :shared :msg :hello))))
(define reader (actor-spawn (lambda (self)
  (ets-lookup :shared :msg))))
(actor-run #20)
(test-case (quote :ets-cross-actor) :hello (actor-result reader))

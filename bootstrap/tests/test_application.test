; Day 100: Application Behavior â€” OTP top-level containers
; Primitives: app-start (app-start), app-stop (app-stop), app-info (app-info),
;             app-which (app-which), app-get-env (app-get-env), app-set-env (app-set-env)
(actor-reset)

; === app-start-basic ===
; Start an application with a start function that returns a supervisor
(actor-reset)
(define my-sup (sup-start :one-for-one (cons (lambda (self) :worker1) nil)))
(define result (app-start :myapp (lambda () my-sup)))
(test-case (quote :app-start-basic) :myapp result)

; === app-which ===
; List running applications
(actor-reset)
(define sup1 (sup-start :one-for-one (cons (lambda (self) :w1) nil)))
(app-start :app1 (lambda () sup1))
(define sup2 (sup-start :one-for-one (cons (lambda (self) :w2) nil)))
(app-start :app2 (lambda () sup2))
(define apps (app-which))
; Should have 2 apps running
(test-case (quote :app-which) #t (and (not (equal? apps nil)) (not (error? apps))))

; === app-info ===
; Get info about a running application
(actor-reset)
(define sup (sup-start :one-for-one (cons (lambda (self) :w) nil)))
(app-start :infoapp (lambda () sup))
(define info (app-info :infoapp))
; Info should be a pair with name and supervisor id
(test-case (quote :app-info) :infoapp (car info))

; === app-info-not-running ===
; Info on non-running app returns nil
(actor-reset)
(test-case (quote :app-info-not-running) nil (app-info :noapp))

; === app-stop ===
; Stop a running application
(actor-reset)
(define sup (sup-start :one-for-one (cons (lambda (self) :worker) nil)))
(app-start :stopme (lambda () sup))
(app-stop :stopme)
(test-case (quote :app-stop) nil (app-info :stopme))

; === app-stop-not-running ===
; Stopping non-running app is an error
(actor-reset)
(test-case (quote :app-stop-not-running) #t (error? (app-stop :noapp)))

; === app-duplicate-name ===
; Starting app with existing name is an error
(actor-reset)
(define sup (sup-start :one-for-one (cons (lambda (self) :w) nil)))
(app-start :dupapp (lambda () sup))
(test-case (quote :app-duplicate-name) #t (error? (app-start :dupapp (lambda () sup))))

; === app-set-get-env ===
; Set and get application environment
(actor-reset)
(define sup (sup-start :one-for-one (cons (lambda (self) :w) nil)))
(app-start :envapp (lambda () sup))
(app-set-env :envapp :port #8080)
(test-case (quote :app-set-get-env) #8080 (app-get-env :envapp :port))

; === app-env-missing ===
; Get missing env key returns nil
(actor-reset)
(define sup (sup-start :one-for-one (cons (lambda (self) :w) nil)))
(app-start :envapp2 (lambda () sup))
(test-case (quote :app-env-missing) nil (app-get-env :envapp2 :nope))

; === app-with-supervisor-tree ===
; Application wrapping a real supervision tree with children
(actor-reset)
(define sup (sup-start :one-for-one
  (cons (lambda (self) (actor-receive))
  (cons (lambda (self) (actor-receive))
  nil))))
(app-start :treeapp (lambda () sup))
(define info (app-info :treeapp))
(define sid (car (cdr info)))
(define children (sup-children sid))
; Should have 2 children
(test-case (quote :app-with-supervisor-tree) #t (not (equal? children nil)))

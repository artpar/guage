; Day 97: GenServer / Call-Reply tests — ⟳⇅, ⟳⇅!

; Reset state
(⟳∅)

; === call-reply-basic ===
; Basic synchronous call-reply pattern
(⟳∅)
(≔ server (⟳ (λ (self)
  (≫ (←?) (λ (msg)
    (≫ (⟳⇅! (◁ (▷ msg)) (⊕ (◁ (▷ (▷ msg))) #10)) (λ (_)
      :done)))))))
; Server receives ⟨:call caller-id request⟩, replies with request+10
(≔ client (⟳ (λ (self)
  (⟳⇅ server #5))))
(⟳! #20)
(⊨ (⌜ :call-reply-basic) #15 (⟳→ client))

; === call-reply-echo ===
; Server echoes back the request
(⟳∅)
(≔ echo-server (⟳ (λ (self)
  (≫ (←?) (λ (msg)
    (⟳⇅! (◁ (▷ msg)) (◁ (▷ (▷ msg)))))))))
(≔ client (⟳ (λ (self)
  (⟳⇅ echo-server :hello))))
(⟳! #20)
(⊨ (⌜ :call-reply-echo) :hello (⟳→ client))

; === call-reply-multiple ===
; Multiple sequential calls to same server
(⟳∅)
(≔ counter (⟳ (λ (self)
  (≫ (←?) (λ (msg1)
    (≫ (⟳⇅! (◁ (▷ msg1)) #1) (λ (_)
      (≫ (←?) (λ (msg2)
        (⟳⇅! (◁ (▷ msg2)) #2))))))))))
(≔ client (⟳ (λ (self)
  (≫ (⟳⇅ counter :a) (λ (r1)
    (≫ (⟳⇅ counter :b) (λ (r2)
      (⟨⟩ r1 r2))))))))
(⟳! #50)
(⊨ (⌜ :call-reply-multiple) (⟨⟩ #1 #2) (⟳→ client))

; === call-not-actor ===
; Calling non-actor returns error
(⟳∅)
(⊨ (⌜ :call-not-actor) #t (⚠? (⟳⇅ #42 :req)))

; === call-dead-actor ===
; Calling dead actor returns error
(⟳∅)
(≔ dead (⟳ (λ (self) :done)))
(⟳! #5)
(≔ client (⟳ (λ (self) (⟳⇅ dead :req))))
(⟳! #10)
(⊨ (⌜ :call-dead-actor) #t (⚠? (⟳→ client)))

; === reply-not-actor ===
; Reply to non-actor returns error
(⟳∅)
(⊨ (⌜ :reply-not-actor) #t (⚠? (⟳⇅! #999 :response)))

; === call-with-registered ===
; Call a registered server by name lookup
(⟳∅)
(≔ srv (⟳ (λ (self)
  (≫ (←?) (λ (msg)
    (⟳⇅! (◁ (▷ msg)) :pong))))))
(⟳⊜⊕ :ping-server srv)
(≔ client (⟳ (λ (self)
  (⟳⇅ (⟳⊜? :ping-server) :ping))))
(⟳! #20)
(⊨ (⌜ :call-with-registered) :pong (⟳→ client))

; === call-message-format ===
; Verify the message format sent to server is ⟨:call caller-id request⟩
(⟳∅)
(≔ inspect-server (⟳ (λ (self)
  (≫ (←?) (λ (msg)
    (≫ (⟳⇅! (◁ (▷ msg)) msg) (λ (_)
      :done)))))))
(≔ client (⟳ (λ (self)
  (⟳⇅ inspect-server :test-req))))
(⟳! #20)
; The reply is the raw message the server received
(≔ raw-msg (⟳→ client))
(⊨ (⌜ :call-message-format) :call (◁ raw-msg))

; === call-with-timer ===
; Combine call with timer — delayed reply
(⟳∅)
(≔ delayed-server (⟳ (λ (self)
  (≫ (←?) (λ (msg)
    (≫ (⟳⏱ #3 self msg) (λ (_)
      (≫ (←?) (λ (timer-msg)
        (⟳⇅! (◁ (▷ timer-msg)) :delayed-response))))))))))
(≔ client (⟳ (λ (self)
  (⟳⇅ delayed-server :req))))
(⟳! #30)
(⊨ (⌜ :call-with-timer) :delayed-response (⟳→ client))

; === call-outside-actor ===
; Call from outside actor context returns error
(⟳∅)
(≔ srv (⟳ (λ (self) (←?))))
(⊨ (⌜ :call-outside-actor) #t (⚠? (⟳⇅ srv :req)))
